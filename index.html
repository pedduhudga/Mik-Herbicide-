<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herbicide Trial Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pptxgenjs/3.12.0/pptxgen.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .nav-link { transition: all 0.2s ease-in-out; border-bottom: 2px solid transparent; padding-top: 1rem; padding-bottom: 1rem; cursor: pointer; }
        .nav-link.active { border-bottom-color: #3b82f6; color: #3b82f6; font-weight: 600; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.5); animation: fadeIn 0.3s; }
        #cropper-modal { z-index: 1050; }
        .modal-content { animation: slideIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 2000; left: 50%; bottom: 30px; font-size: 17px; opacity: 0; transition: visibility 0.5s, opacity 0.5s linear; }
        .toast.show { visibility: visible; opacity: 1; }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        #cropper-container > img { max-width: 100%; max-height: 70vh; }
        #ai-chat-box { height: calc(100vh - 25rem); }
        .ai-message { background-color: #e5e7eb; }
        .user-message { background-color: #dbeafe; align-self: flex-end; }
    </style>
</head>
<body class="antialiased">
    <!-- CONFIGURATION -->
    <script>
        const DEFAULT_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz_KfIv5w-UeCimBSjdgSJWIC57O5eU87gBK6IZJdb-PR8F3fjY3-Jc0Oq0xwDld54A/exec';
        // IMPORTANT: Replace this with your own Google Client ID from Google Cloud Platform for the sign-in feature to work.
        const GOOGLE_CLIENT_ID = '296425330223-m7p504qt7l1nc7gjnj2iolnf7di67n8a.apps.googleusercontent.com'; 
        const CURRENCY_SYMBOL = 'â‚¹';
    </script>
    <!-- App Container -->
    <div id="app-container" class="hidden">
        <div class="min-h-screen bg-gray-100">
            <header class="bg-white shadow-sm"><div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center"><h1 class="text-2xl font-bold text-gray-800">Herbicide Trial Manager</h1></div></header>
            <nav class="bg-white border-b border-gray-200"><div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"><div class="flex items-center space-x-8 -mb-px">
                <a class="nav-link active text-sm font-medium" data-page="formulations">Formulations</a>
                <a class="nav-link text-sm font-medium" data-page="trials">Trials</a>
                <a class="nav-link text-sm font-medium" data-page="organisations">Organisations</a>
                <a class="nav-link text-sm font-medium" data-page="ingredients">Ingredient Costs</a>
                <a class="nav-link text-sm font-medium" data-page="aiAssistant">AI Assistant</a>
                <a class="nav-link text-sm font-medium" data-page="dataMgmt">Data Mgmt</a>
                <a class="nav-link text-sm font-medium" data-page="settings">Settings</a>
            </div></div></nav>
            <main id="main-content" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"></main>
        </div>
    </div>

    <!-- Onboarding Screen -->
    <div id="onboarding-container" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="max-w-xl w-full bg-white p-8 rounded-lg shadow-lg text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Welcome to the Herbicide Trial Manager</h2>
            <p class="text-gray-600 mb-6">To get started with your own private data, please sign in with your Google account.</p>
            <div id="google-signin-button"></div>
            <div id="setup-section" class="hidden mt-6">
                 <p class="text-sm text-gray-500 mb-4">You are signed in. Click the button below to automatically create a copy of the database and photo folder in your Google Drive.</p>
                <button id="create-backend-button" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition">Create My Personal Backend</button>
            </div>
             <div class="mt-8 border-t pt-6">
                <p class="text-sm text-gray-500 mb-4">If you have already set up your backend, please go to the Settings page to enter your URLs.</p>
                <button id="go-to-settings-button" class="text-sm text-blue-600 hover:underline">Go to Settings &raquo;</button>
            </div>
        </div>
    </div>

    <!-- Modals & Overlays -->
    <div id="modal-container"></div>
    <div id="cropper-modal" class="modal"><div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-4xl mx-auto mt-10"><h3 class="text-lg font-bold mb-4">Crop Image</h3><div id="cropper-container" class="mb-4 bg-gray-200"><img id="image-to-crop"></div><div class="flex justify-end space-x-3"><button data-action="cancel-crop" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button><button data-action="crop-image" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Crop & Save Image</button></div></div></div>
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center hidden"><div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white"></div></div>
    <div id="toast" class="toast"></div>
    
    <script>
    window.addEventListener('load', () => {
        let state = { 
            currentPage: 'formulations', 
            ingredients: [], 
            formulations: [], 
            trials: [], 
            organisations: [], 
            selectedTrials: [], 
            photoQueue: [], 
            croppedPhotosData: [], 
            geminiApiKey: '',
            settings: {
                scriptUrl: DEFAULT_SCRIPT_URL,
                sheetId: null,
                folderId: null
            },
            auth: {
                token: null
            }
        };

        const mainContent = document.getElementById('main-content');
        const modalContainer = document.getElementById('modal-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        const toast = document.getElementById('toast');
        const cropperModal = document.getElementById('cropper-modal');
        const imageToCrop = document.getElementById('image-to-crop');
        const appContainer = document.getElementById('app-container');
        const onboardingContainer = document.getElementById('onboarding-container');
        let cropper = null;

        const templates = {
            page: (pageId) => ({
                formulations: `<div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4"><div><h2 class="text-xl font-semibold text-gray-700">My Formulations</h2></div><div class="flex-grow"><input type="search" data-action="filter" data-type="formulation" placeholder="Search formulations by name..." class="w-full px-4 py-2 border rounded-lg"></div><div><button data-action="openModal" data-type="formulation" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition w-full md:w-auto">+ Add New Formulation</button></div></div><div id="formulations-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>`,
                trials: `<div class="bg-white p-4 rounded-lg shadow-md mb-6"><h3 class="font-semibold text-gray-800 mb-2">Filters</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><input type="search" data-action="filter" data-type="trial-search" placeholder="Search investigator, species..." class="w-full px-4 py-2 border rounded-lg"><select data-action="filter" data-type="trial-formulation" class="p-2 border rounded-lg bg-white"><option value="">Filter by Formulation</option></select><div class="grid grid-cols-2 gap-2"><input type="date" data-action="filter" data-type="trial-start-date" class="p-2 border rounded-lg" title="Start Date"><input type="date" data-action="filter" data-type="trial-end-date" class="p-2 border rounded-lg" title="End Date"></div></div></div><div class="flex justify-end mb-6"><button data-action="openModal" data-type="trial" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition w-full sm:w-auto">+ Log New Trial</button></div><div id="trials-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div><div id="organise-bar" class="hidden fixed bottom-10 left-1/2 -translate-x-1/2 bg-gray-800 text-white py-3 px-6 rounded-lg shadow-lg flex items-center gap-4 z-20"><span id="selected-trials-count"></span><button data-action="open-organise-modal" class="bg-indigo-500 hover:bg-indigo-600 px-4 py-2 rounded-md text-sm font-semibold">Add to Organisation</button></div>`,
                organisations: `<div class="flex justify-between items-center mb-6"><div><h2 class="text-xl font-semibold text-gray-700">Trial Organisations</h2><p class="text-sm text-gray-500">Group trials together for easier analysis.</p></div></div><div id="organisations-list" class="space-y-8"></div>`,
                ingredients: `<div class="bg-white p-6 rounded-lg shadow mb-8"><h3 class="text-lg font-medium text-gray-800">Bulk Add Ingredients</h3><p class="text-sm text-gray-500 mb-2">Enter multiple ingredients in the format: Name Cost Unit, ... (e.g., Glyphosate 15000 L, Paraquat 8000 kg)</p><div class="flex gap-2"><textarea id="bulk-ingredients-cost-input" placeholder="IngredientA 100 kg, IngredientB 50 L" class="w-full p-2 border border-gray-300 rounded-md" rows="4"></textarea><button type="button" data-action="apply-bulk-add-cost" class="bg-indigo-600 text-white px-4 py-2 rounded-lg self-start">Add Bulk</button></div></div><div class="flex justify-between items-center mb-6"><h2 class="text-xl font-semibold text-gray-700">Ingredient Costs</h2><button data-action="openModal" data-type="ingredient" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition">+ Add New Cost</button></div><div id="ingredients-list" class="bg-white p-6 rounded-lg shadow"></div>`,
                aiAssistant: `<div class="bg-white p-6 rounded-lg shadow"><h2 class="text-xl font-semibold text-gray-700 mb-4">AI Assistant</h2><div id="ai-chat-box" class="border rounded-lg p-4 overflow-y-auto mb-4 bg-gray-50 flex flex-col gap-2"><div class="ai-message p-3 rounded-lg max-w-xl">Hello! Ask me about your trial data or any other questions you have.</div></div><form id="ai-form" class="flex gap-4"><input type="text" id="ai-input" placeholder="E.g., Which formulation had the best result?" class="flex-grow p-2 border rounded-lg" required><button type="submit" class="bg-blue-600 text-white px-5 py-2 rounded-lg">Send</button></form></div>`,
                dataMgmt: `<div class="space-y-8"><div><h2 class="text-xl font-semibold text-gray-700 mb-4">Export Data</h2><div class="bg-white p-6 rounded-lg shadow"><p class="text-gray-600 mb-4">Download all your data as a JSON file for backup or as a ZIP with photos.</p><div class="flex gap-4"><button data-action="export-json" class="bg-green-600 text-white px-4 py-2 rounded-lg">Export to JSON</button><button data-action="export-zip" class="bg-green-700 text-white px-4 py-2 rounded-lg">Export with Photos</button></div></div></div><div><h2 class="text-xl font-semibold text-gray-700 mb-4">Import Data</h2><div class="bg-white p-6 rounded-lg shadow"><p class="text-gray-600 mb-4">Upload a previously exported JSON file to restore your data. <strong class="text-red-600">This will overwrite all current data.</strong></p><input type="file" id="import-file-input" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" accept=".json"><button data-action="import-json" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg" disabled>Import from JSON</button></div></div><div><h2 class="text-xl font-semibold text-gray-700 mb-4">Clear All Data</h2><div class="bg-white p-6 rounded-lg shadow border-red-300"><p class="text-gray-600 mb-4">Permanently delete all your data. <strong class="text-red-600">This action cannot be undone.</strong></p><button data-action="clear-data" class="bg-red-600 text-white px-4 py-2 rounded-lg">Clear All Data</button></div></div></div>`,
                settings: `<div class="bg-white p-6 rounded-lg shadow space-y-8">
                                <div>
                                    <h2 class="text-xl font-semibold text-gray-700 mb-4">AI Assistant</h2>
                                    <p class="text-sm text-gray-600 mb-2">Enter your Google Gemini API Key below to enable the AI Assistant.</p>
                                    <form id="settings-form" class="flex items-end gap-4"><div class="flex-grow"><label for="gemini-api-key" class="block text-sm font-medium text-gray-700">Gemini API Key</label><input type="password" id="gemini-api-key" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div><button type="submit" class="bg-blue-600 text-white px-5 py-2 rounded-lg">Save Key</button></form>
                                </div>
                                <div class="border-t pt-8">
                                    <h3 class="text-lg font-medium text-gray-900">Data Source Settings</h3>
                                    <p class="mt-1 text-sm text-gray-600">For multi-user support, you can connect the app to your own Google Sheet and Drive folder.</p>
                                    <form id="data-source-form" class="mt-4 space-y-4">
                                        <div>
                                            <label for="script-url" class="block text-sm font-medium text-gray-700">Apps Script Web App URL</label>
                                            <input type="url" id="script-url" placeholder="Paste the full URL of your deployed Apps Script" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                        </div>
                                        <div>
                                            <label for="sheet-url" class="block text-sm font-medium text-gray-700">Google Sheet URL</label>
                                            <input type="url" id="sheet-url" placeholder="Paste the full URL of your Google Sheet copy" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                        </div>
                                        <div>
                                            <label for="folder-url" class="block text-sm font-medium text-gray-700">Google Drive Photo Folder URL</label>
                                            <input type="url" id="folder-url" placeholder="Paste the full URL of your photo folder" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                        </div>
                                        <div class="flex items-center justify-between pt-2">
                                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Save Data Sources</button>
                                            <button type="button" data-action="reset-data-sources" class="text-sm text-gray-500 hover:text-gray-700">Reset to Default</button>
                                        </div>
                                    </form>
                                </div>
                           </div>`,
            })[pageId] || '',
            modal: (modalId, isEdit = false, data = {}) => {
                const modalTemplates = {
                    ingredient: `<div id="ingredient-modal" class="modal"><div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-auto mt-20"><h3 class="text-lg font-bold mb-4">${isEdit ? 'Edit' : 'Add'} Ingredient</h3><form id="ingredient-form"><input type="hidden" name="id"><div class="mb-4"><label class="block text-sm font-medium text-gray-700">Ingredient Name</label><input type="text" name="name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700">Cost</label><input type="number" name="cost" step="0.01" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div><div><label class="block text-sm font-medium text-gray-700">Base Unit</label><select name="unit" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white"><option value="L">L</option><option value="kg">kg</option><option value="ml">ml</option><option value="gm">gm</option></select></div></div><div class="mt-6 flex justify-end space-x-3"><button type="button" data-action="close-modal" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg">Cancel</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Save</button></div></form></div></div>`,
                    formulation: `<div id="formulation-modal" class="modal"><div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl mx-auto mt-10"><h3 class="text-lg font-bold mb-4">${isEdit ? 'Edit' : 'Add'} Formulation</h3><form id="formulation-form"><input type="hidden" name="id"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><input type="text" name="name" required placeholder="Formulation Name" class="p-2 border border-gray-300 rounded-md"><input type="text" name="notes" placeholder="Notes" class="p-2 border border-gray-300 rounded-md"></div><div class="mt-6"><h4 class="text-md font-medium text-gray-800">Bulk Add Ingredients</h4><p class="text-sm text-gray-500 mb-2">Enter ingredients in the format: Name QuantityUnit, ...</p><div class="flex gap-2"><textarea id="bulk-ingredients-input" placeholder="Pelargonic Acid 50ML, Capric Acid 20ML" class="w-full p-2 border border-gray-300 rounded-md" rows="3"></textarea><button type="button" data-action="apply-bulk-add" class="bg-indigo-600 text-white px-4 py-2 rounded-lg self-start">Add</button></div></div><div class="mt-6"><h4 class="text-md font-medium text-gray-800">Ingredients</h4><div id="formulation-ingredients-container" class="mt-2 space-y-3"></div><button type="button" data-action="add-ingredient-row" class="mt-3 text-sm text-blue-600 hover:text-blue-800">+ Add Another Ingredient</button></div><div class="mt-6 border-t pt-4"><p class="font-semibold">Total Cost: <span id="formulation-total-cost">${CURRENCY_SYMBOL}0.00</span></p></div><div class="mt-6 flex justify-end space-x-3"><button type="button" data-action="close-modal" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg">Cancel</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Save</button></div></form></div></div>`,
                    trial: `<div id="trial-modal" class="modal"><div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-3xl mx-auto mt-10"><h3 class="text-lg font-bold mb-4">${isEdit ? 'Edit' : 'Log'} Trial</h3><form id="trial-form"><input type="hidden" name="id"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><input type="text" name="investigatorName" required placeholder="Investigator Name" class="p-2 border border-gray-300 rounded-md" list="investigator-list"><datalist id="investigator-list"></datalist><select name="formulationId" id="trial-formulation" required class="p-2 border border-gray-300 rounded-md bg-white"></select><input type="text" name="dosage" placeholder="Dosage" class="p-2 border border-gray-300 rounded-md"><input type="text" name="weedSpecies" placeholder="Weed Species" class="p-2 border border-gray-300 rounded-md"><input type="date" name="date" id="trial-date" required class="p-2 border border-gray-300 rounded-md"><div class="md:col-span-2 flex items-center gap-2"><input type="checkbox" id="control-finalized" name="controlFinalized" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"><label for="control-finalized" class="text-sm text-gray-700">Mark final control day (stops counting)</label></div></div><div class="mt-6 p-4 bg-gray-50 rounded-lg"><div class="flex justify-between items-center mb-2"><h4 class="text-md font-medium text-gray-800">Weather Conditions</h4><button type="button" data-action="fetch-weather" class="text-sm text-blue-600 hover:text-blue-800 font-semibold">Fetch Current Weather</button></div><div class="grid grid-cols-2 md:grid-cols-4 gap-4"><input type="text" name="temperature" placeholder="Temp (Â°C)" class="p-2 border border-gray-300 rounded-md text-sm"><input type="text" name="humidity" placeholder="Humidity (%)" class="p-2 border border-gray-300 rounded-md text-sm"><input type="text" name="windspeed" placeholder="Wind (km/h)" class="p-2 border border-gray-300 rounded-md text-sm"><input type="text" name="rain" placeholder="Rain (mm)" class="p-2 border border-gray-300 rounded-md text-sm"></div></div><div class="mt-6 grid grid-cols-1 gap-6"><textarea name="conclusion" rows="3" placeholder="Conclusion" class="p-2 border border-gray-300 rounded-md"></textarea><textarea name="notes" rows="2" placeholder="Trial Notes" class="p-2 border border-gray-300 rounded-md"></textarea></div><div class="mt-6"><label class="block text-sm font-medium text-gray-700">Add & Crop Photos</label><input type="file" id="trial-photos" multiple accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"><div id="photo-preview" class="mt-2 flex flex-wrap gap-4"></div></div><div class="mt-6 flex justify-end space-x-3"><button type="button" data-action="close-modal" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg">Cancel</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Save</button></div></form></div></div>`,
                    confirm: `<div id="confirm-modal" class="modal"><div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-sm mx-auto mt-20"><h3 id="confirm-title" class="text-lg font-bold mb-4">Are you sure?</h3><p id="confirm-message" class="text-gray-600 mb-6">This action cannot be undone.</p><div class="flex justify-end space-x-3"><button data-action="confirm-cancel" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg">Cancel</button><button data-action="confirm-ok" class="bg-red-600 text-white px-4 py-2 rounded-lg">Confirm</button></div></div></div>`,
                    trialDetail: () => {
                        const { trial } = data;
                        if (!trial) return '';
                        const photos = JSON.parse(trial.PhotoURLs || '[]').map(p => {
                            const proxiedUrl = p.url ? `https://images.weserv.nl/?url=${encodeURIComponent(p.url)}` : '';
                            return `<figure class="text-center"><a href="${p.url}" target="_blank"><img src="${proxiedUrl}" class="h-48 w-auto object-cover rounded-md border"></a><figcaption class="text-sm text-gray-600 mt-1">${p.label || ''}</figcaption></figure>`
                        }).join('');

                        return `<div id="trial-detail-modal" class="modal"><div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-5xl mx-auto mt-10"><h3 class="text-2xl font-bold mb-6">Herbicide Trial Report: ${trial.FormulationName}</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div class="space-y-2 text-gray-800"><p><strong>Investigator:</strong> ${trial.InvestigatorName || 'N/A'}</p><p><strong>Dosage:</strong> ${trial.Dosage || 'N/A'}</p><p><strong>Weed Species:</strong> ${trial.WeedSpecies || 'N/A'}</p><p><strong>Date:</strong> ${new Date(trial.Date).toLocaleDateString()}</p>${ trial.Temperature ? `<div class="mt-4 pt-4 border-t"><p class="font-semibold text-gray-500 text-sm">Weather Conditions</p><p><strong>Temperature:</strong> ${trial.Temperature}Â°C</p><p><strong>Humidity:</strong> ${trial.Humidity}%</p><p><strong>Wind:</strong> ${trial.Windspeed} km/h</p><p><strong>Rain:</strong> ${trial.Rain} mm</p></div>` : '' }<div class="mt-4 pt-4 border-t"><p><strong>Conclusion:</strong> ${trial.Conclusion || 'N/A'}</p><p><strong>Notes:</strong> ${trial.Notes || 'N/A'}</p></div></div><div><h4 class="text-lg font-semibold mb-2">Photos</h4><div class="flex flex-wrap gap-4">${photos || 'No photos available.'}</div></div></div><div class="mt-8 border-t pt-6 flex flex-wrap justify-center gap-3"><button data-action="export-pdf-with-ingredients" data-id="${trial.ID}" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg text-sm">Export as PDF with Ingredients</button><button data-action="export-pdf-without-ingredients" data-id="${trial.ID}" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg text-sm">Export as PDF without Ingredients</button><button data-action="export-pdf-landscape" data-id="${trial.ID}" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg text-sm">Download as PDF Landscape</button><button data-action="export-ppt" data-id="${trial.ID}" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg text-sm">Export as PPT</button><button data-action="close-modal" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">Go Back</button></div></div></div>`;
                    },
                    organise: `<div id="organise-modal" class="modal"><div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-auto mt-20"><h3 class="text-lg font-bold mb-4">Add to Organisation</h3><form id="organise-form"><div class="mb-4"><label class="block text-sm font-medium text-gray-700">Select Existing Organisation</label><select name="organisationId" id="existing-organisations" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"><option value="">-- Choose existing --</option>${state.organisations.map(o => `<option value="${o.ID}">${o.Name}</option>`).join('')}</select></div><div class="text-center my-2 text-gray-500">OR</div><div class="mb-4"><label class="block text-sm font-medium text-gray-700">Create New Organisation</label><input type="text" name="newOrganisationName" placeholder="e.g., Summer 2025 Variants" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div><div class="mt-6 flex justify-end space-x-3"><button type="button" data-action="close-modal" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg">Cancel</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Save</button></div></form></div></div>`
                };
                const template = modalTemplates[modalId];
                if (typeof template === 'function') {
                    return template();
                }
                return template || '';
            }
        };

        const render = {
            trialCard: (trial, showCheckbox = false) => {
                const formulation = state.formulations.find(f => f.ID === trial.FormulationID);
                const cost = formulation ? parseFloat(formulation.EstimatedCost || 0).toFixed(2) : '0.00';
                let controlDuration;
                if (trial.ControlFinalized && trial.FinalControlDuration != null) {
                    controlDuration = `${trial.FinalControlDuration} Days (Final)`;
                } else if (trial.Date) {
                    const days = Math.floor((new Date() - new Date(trial.Date)) / (1000 * 60 * 60 * 24));
                    controlDuration = `${days < 0 ? 0 : days} Days`;
                } else {
                    controlDuration = 'N/A';
                }
                const photos = JSON.parse(trial.PhotoURLs || '[]').map(p => {
                    const proxiedUrl = p.url ? `https://images.weserv.nl/?url=${encodeURIComponent(p.url)}` : '';
                    return `<img src="${proxiedUrl}" class="h-16 w-16 object-cover rounded-md border" alt="${p.label || 'Trial photo'}">`
                }).join('');

                return `
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <div class="flex items-start gap-4">
                        ${showCheckbox ? `<input type="checkbox" data-action="select-trial" data-id="${trial.ID}" class="mt-1 h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">` : ''}
                        <div class="flex-grow">
                            <div class="flex justify-between items-start cursor-pointer" data-action="view-trial" data-id="${trial.ID}">
                                <div class="flex-grow">
                                    <h3 class="font-bold text-lg">${trial.FormulationName}</h3>
                                    <div class="grid grid-cols-2 gap-x-4 text-sm text-gray-600 mt-2">
                                        <p><strong>Dosage:</strong> ${trial.Dosage || 'N/A'}</p>
                                        <p class="text-blue-600 font-semibold"><strong>Control:</strong> ${controlDuration}</p>
                                        <p><strong>Date:</strong> ${trial.Date ? new Date(trial.Date).toLocaleDateString() : 'N/A'}</p>
                                        <p class="font-semibold"><strong>Cost:</strong> ${CURRENCY_SYMBOL}${cost}</p>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end gap-2 ml-4">
                                    <button data-action="edit" data-type="trial" data-id="${trial.ID}" class="text-blue-600 hover:text-blue-800 font-semibold text-sm px-3 py-1">Edit</button>
                                    <button data-action="delete" data-type="trial" data-id="${trial.ID}" class="text-red-500 hover:text-red-700 font-semibold text-sm px-3 py-1">Delete</button>
                                </div>
                            </div>
                            ${photos ? `<div class="mt-4"><div class="flex flex-wrap gap-2">${photos}</div></div>` : ''}
                        </div>
                    </div>
                </div>`;
            },
            ingredients: (data = state.ingredients) => { const el = document.getElementById('ingredients-list'); if(el) el.innerHTML = `<ul class="divide-y divide-gray-200">${(data || []).map(ing => `<li class="py-3 flex justify-between items-center"><div><p class="font-medium">${ing.Name}</p><p class="text-sm text-gray-500">${CURRENCY_SYMBOL}${parseFloat(ing.Cost).toFixed(2)} / ${ing.Unit}</p></div><div class="flex gap-4"><button data-action="edit" data-type="ingredient" data-id="${ing.ID}" class="text-blue-600 hover:text-blue-800 font-bold">Edit</button><button data-action="delete" data-type="ingredient" data-id="${ing.ID}" class="text-red-500 hover:text-red-700 font-bold">&times;</button></div></li>`).join('') || '<p class="text-gray-500">No ingredients.</p>'}</ul>`; },
            formulations: (data = state.formulations) => { const el = document.getElementById('formulations-list'); if(el) el.innerHTML = (data || []).map(form => `<div class="bg-white p-6 rounded-lg shadow-md relative"><div class="absolute top-4 right-4 flex gap-2"><button data-action="edit" data-type="formulation" data-id="${form.ID}" class="btn-secondary px-3 py-1 rounded-md text-sm">Edit</button><button data-action="delete" data-type="formulation" data-id="${form.ID}" class="text-red-500 font-bold text-xl">&times;</button></div><h3 class="font-bold text-lg">${form.Name}</h3><div class="mt-2 text-sm text-gray-600"><ul class="list-disc list-inside">${JSON.parse(form.IngredientsJSON || '[]').map(ing => `<li>${ing.name} (${ing.quantity} ${ing.unit})</li>`).join('')}</ul>${form.Notes ? `<p class="mt-2"><strong>Notes:</strong> ${form.Notes}</p>` : ''}</div><p class="mt-4 font-semibold">Cost: ${CURRENCY_SYMBOL}${parseFloat(form.EstimatedCost || 0).toFixed(2)}</p></div>`).join('') || '<p class="text-gray-500 col-span-full">No formulations found.</p>'; },
            trials: (data = state.trials) => {
                const el = document.getElementById('trials-list');
                if (!el) return;
                el.innerHTML = (data || []).map(trial => render.trialCard(trial, true)).join('') || '<p class="text-gray-500">No trials found.</p>';
            },
             organisations: (data = state.organisations) => {
                const el = document.getElementById('organisations-list');
                if (!el) return;
                el.innerHTML = (data || []).map(org => {
                    const trialDetails = (JSON.parse(org.TrialIDs || '[]')).map(trialId => state.trials.find(t => t.ID === trialId)).filter(Boolean);
                    return `<div class="bg-white p-6 rounded-lg shadow-md">
                                <div class="flex justify-between items-start mb-4">
                                    <h3 class="font-bold text-xl text-gray-800">${org.Name}</h3>
                                    <button data-action="delete" data-type="organisation" data-id="${org.ID}" class="text-red-500 hover:text-red-700 font-semibold text-sm">Delete</button>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    ${trialDetails.length > 0 ? trialDetails.map(t => render.trialCard(t, false)).join('') : '<p class="text-gray-500 col-span-full">No trials in this organisation.</p>'}
                                </div>
                            </div>`;
                }).join('') || '<p class="text-gray-500">No organisations created yet. Go to the Trials page to group some together.</p>';
            },
        };

        async function apiCall(action, payload = {}, showOverlay = true) {
            if (showOverlay) loadingOverlay.classList.remove('hidden');
            try {
                const fullPayload = {
                    ...payload,
                    spreadsheetId: state.settings.sheetId,
                    folderId: state.settings.folderId
                };

                const res = await fetch(state.settings.scriptUrl, { method: 'POST', body: JSON.stringify({ action, payload: fullPayload }), redirect: 'follow' });
                if (!res.ok) throw new Error(`Network error: ${res.statusText}`);
                const result = await res.json();
                if (result.status === 'error') {
                    console.error('Server-side error:', result.stack);
                    throw new Error(result.message);
                }
                return result.data;
            } catch (error) {
                console.error('API Error:', error);
                showToast(error.message, 'error');
                return null;
            } finally {
                if (showOverlay) loadingOverlay.classList.add('hidden');
            }
        }
        
        function showToast(message, type = 'success') { toast.textContent = message; toast.className = `toast show ${type}`; setTimeout(() => { toast.className = toast.className.replace('show', ''); }, 3000); }
        
        function switchPage(pageId) {
            state.currentPage = pageId;
            state.selectedTrials = [];
            updateOrganiseBar();
            mainContent.innerHTML = templates.page(pageId);
            document.querySelectorAll('.nav-link').forEach(link => link.classList.toggle('active', link.dataset.page === pageId));
            
            const renderFn = render[pageId];
            if (renderFn) renderFn(state[pageId]);
            
            if (pageId === 'trials') {
                const filterSelect = mainContent.querySelector('[data-type="trial-formulation"]');
                const formulationNames = [...new Set((state.trials || []).map(t => t.FormulationName).filter(Boolean))].sort();
                if(filterSelect) filterSelect.innerHTML = `<option value="">Filter by Formulation</option>${formulationNames.map(name => `<option value="${name}">${name}</option>`).join('')}`;
            }
            if (pageId === 'settings') {
                document.getElementById('gemini-api-key').value = state.geminiApiKey || '';
                document.getElementById('script-url').value = state.settings.scriptUrl || '';
                document.getElementById('sheet-url').value = state.settings.sheetId ? `https://docs.google.com/spreadsheets/d/${state.settings.sheetId}/` : '';
                document.getElementById('folder-url').value = state.settings.folderId ? `https://drive.google.com/drive/folders/${state.settings.folderId}` : '';
            }
        }

        function openModal(id, isEdit = false, data = {}) {
            const content = templates.modal(id, isEdit, data);
            if (!content) {
                console.error("Modal template not found for id:", id);
                return;
            }
            modalContainer.innerHTML = content;
            if (modalContainer.firstChild) {
                modalContainer.firstChild.style.display = 'block';
            }
        }
        function closeModal() { modalContainer.innerHTML = ''; }

        function showConfirmation(title, message, onConfirm) {
            openModal('confirm');
            const modal = document.getElementById('confirm-modal');
            modal.querySelector('#confirm-title').textContent = title;
            modal.querySelector('#confirm-message').textContent = message;

            const okBtn = modal.querySelector('[data-action="confirm-ok"]');
            const cancelBtn = modal.querySelector('[data-action="confirm-cancel"]');
            
            const confirmHandler = () => { onConfirm(); cleanup(); };
            const cancelHandler = () => cleanup();

            const cleanup = () => {
                okBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
                closeModal();
            };
            
            okBtn.addEventListener('click', confirmHandler, { once: true });
            cancelBtn.addEventListener('click', cancelHandler, { once: true });
        }

        function openTrialDetail(trialId) {
            const trial = state.trials.find(t => t.ID === trialId);
            if (trial) {
                openModal('trialDetail', false, { trial });
            }
        }

        function handleOpenModal(type) {
            state.croppedPhotosData = [];
            openModal(type);
            setTimeout(() => {
                if (type === 'trial') {
                    const form = document.getElementById('trial-form');
                    if (!form) return;
                    form.querySelector('#trial-formulation').innerHTML = `<option value="">Select formulation</option>${state.formulations.map(f => `<option value="${f.ID}">${f.Name}</option>`).join('')}`;
                    form.querySelector('#trial-date').valueAsDate = new Date();
                    
                    const investigatorList = document.getElementById('investigator-list');
                    if (investigatorList) {
                        const uniqueInvestigators = [...new Set(state.trials.map(t => t.InvestigatorName).filter(Boolean))];
                        investigatorList.innerHTML = uniqueInvestigators.map(name => `<option value="${name}"></option>`).join('')
                    }

                } else if (type === 'formulation') {
                    addFormulationIngredientRow();
                }
            }, 50);
        }

        function handleEdit(type, id) {
             const data = state[type + 's'].find(item => item.ID === id);
             if (data) {
                 openModal(type, true);
                 setTimeout(() => populateForm(document.getElementById(`${type}-form`), data), 50);
             }
        }

        async function handleDelete(type, id) {
             showConfirmation(`Delete this ${type}?`, `This will permanently remove the ${type}. This action cannot be undone.`, async () => {
                if (type === 'formulation') {
                    const isUsed = state.trials.some(trial => trial.FormulationID === id);
                    if (isUsed) {
                        return showToast('Cannot delete formulation. It is being used in one or more trials.', 'error');
                    }
                }
                loadingOverlay.classList.remove('hidden');
                await apiCall(`delete${type.charAt(0).toUpperCase() + type.slice(1)}`, { id }, false);
                await initializeApp(false); // Reload all data
                loadingOverlay.classList.add('hidden');
                showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} deleted.`);
            });
        }
        
        function calculateFormulationCost(ingredients) {
            if (!ingredients || !state.ingredients) return 0;
            return ingredients.reduce((acc, currentIng) => {
                const ingredientDetails = state.ingredients.find(i => i.ID === currentIng.id);
                if (!ingredientDetails) return acc;
                const costPerBaseUnit = parseFloat(ingredientDetails.Cost);
                if(isNaN(costPerBaseUnit)) return acc;

                const baseUnit = ingredientDetails.Unit ? ingredientDetails.Unit.toLowerCase() : '';
                const usedUnit = currentIng.unit ? currentIng.unit.toLowerCase() : '';

                let quantityInBaseUnit = parseFloat(currentIng.quantity) || 0;
                if ((baseUnit === 'l' && usedUnit === 'ml') || (baseUnit === 'kg' && usedUnit === 'gm')) {
                    quantityInBaseUnit /= 1000;
                } else if ((baseUnit === 'ml' && usedUnit === 'l') || (baseUnit === 'gm' && usedUnit === 'kg')) {
                    quantityInBaseUnit *= 1000;
                } else if (baseUnit !== usedUnit) {
                    return acc;
                }
                return acc + (costPerBaseUnit * quantityInBaseUnit);
            }, 0);
        }

        async function handleFormSubmit(form) {
            if (!form) return;
            const formId = form.getAttribute('id');

            if (formId === 'settings-form') { 
                state.geminiApiKey = document.getElementById('gemini-api-key').value; 
                localStorage.setItem('geminiApiKey', state.geminiApiKey); 
                showToast('API Key saved.'); 
                return; 
            }
             if (formId === 'data-source-form') {
                handleDataSourceSave(form);
                return;
            }

            if (formId === 'ai-form') { handleAiQuery(document.getElementById('ai-input').value); form.reset(); return; }
            if (formId === 'organise-form') { handleOrganiseSubmit(form); return; }

            const type = formId.replace('-form', '');
            
            loadingOverlay.classList.remove('hidden');
            try {
                const idInput = form.querySelector('input[name="id"]');
                const id = idInput ? idInput.value : null;
                const isUpdate = !!id;
                const action = isUpdate ? `update${type.charAt(0).toUpperCase() + type.slice(1)}` : `add${type.charAt(0).toUpperCase() + type.slice(1)}`;
                let payload;

                if (type === 'trial') {
                    const newPhotosToUpload = state.croppedPhotosData.filter(p => !p.isExisting);
                    if (newPhotosToUpload.length > 0) {
                        showToast(`Uploading ${newPhotosToUpload.length} photo(s)...`, 'success');
                    }
                    const existingPhotos = state.croppedPhotosData.filter(p => p.isExisting).map(p => ({ url: p.fileData, label: p.label }));
                    const uploadedPhotoURLs = await uploadPhotos(newPhotosToUpload);
                    const allPhotoURLs = [...existingPhotos, ...uploadedPhotoURLs];
                    
                    const sel = document.getElementById('trial-formulation');
                    if (!sel || !sel.options[sel.selectedIndex] || !sel.value) { throw new Error('Please select a formulation.'); }
                    
                    payload = { ...Object.fromEntries(new FormData(form)), photoURLs: allPhotoURLs };
                    if(isUpdate) payload.id = id;
                    
                    const controlFinalized = form.querySelector('#control-finalized').checked;
                    payload.controlFinalized = controlFinalized;
                    if (controlFinalized) {
                        const days = Math.floor((new Date() - new Date(payload.date)) / (1000 * 60 * 60 * 24));
                        payload.finalControlDuration = days < 0 ? 0 : days;
                    }
                    
                    await apiCall(action, payload, false);
                    
                } else if (type === 'formulation') {
                    const formName = form.querySelector('input[name="name"]').value.trim();
                     if (!isUpdate && state.formulations.some(f => f.Name && f.Name.toLowerCase() === formName.toLowerCase())) {
                        throw new Error(`Formulation name "${formName}" already exists.`);
                    }
                    const ingredients = [...document.querySelectorAll('.formulation-ingredient-row')].map(r => {
                        const selector = r.querySelector('.ingredient-selector');
                        if (!selector || !selector.value) return null;
                         return { 
                            id: selector.value,
                            name: selector.selectedOptions[0].text, 
                            quantity: r.querySelector('.ingredient-quantity').value, 
                            unit: r.querySelector('.ingredient-unit-selector').value 
                        };
                    }).filter(Boolean);

                    if (ingredients.length === 0) throw new Error('Add at least one ingredient.');
                    
                    payload = { ...Object.fromEntries(new FormData(form)), ingredients };
                    if(isUpdate) payload.id = id;
                    
                    await apiCall(action, payload, false);

                } else { // ingredient
                    payload = Object.fromEntries(new FormData(form));
                    if(isUpdate) payload.id = id;
                    await apiCall(action, payload, false);
                }
                
                await initializeApp(false); // Reload all data for consistency
                closeModal();
                showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} saved.`);

            } catch (error) {
                console.error(`Error saving ${type}:`, error);
                showToast(error.message, 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        async function handleOrganiseSubmit(form) {
            const formData = new FormData(form);
            const organisationId = formData.get('organisationId');
            const newOrganisationName = formData.get('newOrganisationName').trim();
            const trialIds = state.selectedTrials;

            if (!organisationId && !newOrganisationName) {
                return showToast('Please select an existing organisation or create a new one.', 'error');
            }
            if (trialIds.length === 0) {
                return showToast('No trials selected.', 'error');
            }

            loadingOverlay.classList.remove('hidden');
            if (newOrganisationName) {
                await apiCall('addOrganisation', { name: newOrganisationName, trialIds }, false);
            } else {
                await apiCall('updateOrganisation', { id: organisationId, trialIds }, false);
            }
            await initializeApp(false); // Reload all data
            loadingOverlay.classList.add('hidden');
            closeModal();
            switchPage('trials');
        }

        function populateForm(form, data) {
             if (!form) return;
             const formId = form.getAttribute('id');
             const idInput = form.querySelector('input[name="id"]');
             if (idInput) idInput.value = data.ID;
             if (formId === 'trial-form') {
                 form.querySelector('[name="investigatorName"]').value = data.InvestigatorName;
                 const formulationSelect = form.querySelector('[name="formulationId"]');
                 formulationSelect.innerHTML = state.formulations.map(f => `<option value="${f.ID}">${f.Name}</option>`).join('');
                 formulationSelect.value = data.FormulationID;
                 form.querySelector('[name="dosage"]').value = data.Dosage;
                 form.querySelector('[name="weedSpecies"]').value = data.WeedSpecies;
                 form.querySelector('[name="date"]').value = new Date(data.Date).toISOString().split('T')[0];
                 form.querySelector('#control-finalized').checked = data.ControlFinalized || false;
                 form.querySelector('[name="conclusion"]').value = data.Conclusion;
                 form.querySelector('[name="notes"]').value = data.Notes;
                 form.querySelector('[name="temperature"]').value = data.Temperature || '';
                 form.querySelector('[name="humidity"]').value = data.Humidity || '';
                 form.querySelector('[name="windspeed"]').value = data.Windspeed || '';
                 form.querySelector('[name="rain"]').value = data.Rain || '';
                 state.croppedPhotosData = JSON.parse(data.PhotoURLs || '[]').map((p, i) => ({ fileData: p.url, label: p.label, fileName: `existing_image_${i}.jpg`, isExisting: true }));
                 updatePhotoPreview();
             } else if (formId === 'formulation-form') {
                  form.querySelector('[name="name"]').value = data.Name;
                  form.querySelector('[name="notes"]').value = data.Notes;
                  const ingredients = JSON.parse(data.IngredientsJSON || '[]')
                  document.getElementById('formulation-ingredients-container').innerHTML = '';
                  ingredients.forEach(ing => addFormulationIngredientRow(ing));
                  updateFormulationCost();
             } else if (formId === 'ingredient-form') {
                 form.querySelector('[name="name"]').value = data.Name;
                 form.querySelector('[name="cost"]').value = data.Cost;
                 form.querySelector('[name="unit"]').value = data.Unit;
             }
        }

        function applyFilters() {
            let filteredTrials = [...(state.trials || [])];
            
            const searchTerm = document.querySelector('[data-type="trial-search"]').value.toLowerCase();
            if (searchTerm) {
                filteredTrials = filteredTrials.filter(t => (t.InvestigatorName && t.InvestigatorName.toLowerCase().includes(searchTerm)) || (t.WeedSpecies && t.WeedSpecies.toLowerCase().includes(searchTerm)));
            }

            const formulationFilter = document.querySelector('[data-type="trial-formulation"]').value;
            if (formulationFilter) {
                filteredTrials = filteredTrials.filter(t => t.FormulationName === formulationFilter);
            }

            const startDate = document.querySelector('[data-type="trial-start-date"]').value;
            if (startDate) {
                filteredTrials = filteredTrials.filter(t => new Date(t.Date) >= new Date(startDate));
            }

            const endDate = document.querySelector('[data-type="trial-end-date"]').value;
            if (endDate) {
                filteredTrials = filteredTrials.filter(t => new Date(t.Date) <= new Date(endDate));
            }

            render.trials(filteredTrials);
        }
        
        async function handleBulkIngredientsCost() {
            const text = document.getElementById('bulk-ingredients-cost-input').value;
            if (!text) return showToast('Input cannot be empty.', 'error');

            loadingOverlay.classList.remove('hidden');
            try {
                const entries = text.split(',').map(s => s.trim()).filter(Boolean);
                if (entries.length === 0) throw new Error("No valid entries found.");

                const ingredientPromises = entries.map(entry => {
                    const match = entry.match(/^(.*?)\s+([\d\.]+)\s+(\w+)$/);
                    if (!match) {
                        console.warn(`Skipping invalid entry: "${entry}"`);
                        return null; // Skip invalid entries
                    }
                    const [, name, cost, unit] = match.map(s => s.trim());
                    
                    if (state.ingredients.some(ing => ing.Name && ing.Name.toLowerCase() === name.toLowerCase())) {
                        console.warn(`Skipping duplicate ingredient: "${name}"`);
                        return null;
                    }
                    
                    return apiCall('addIngredient', { name, cost, unit }, false);
                });

                const results = await Promise.all(ingredientPromises.filter(Boolean));
                const addedCount = results.filter(Boolean).length;

                if (addedCount > 0) {
                    showToast(`${addedCount} new ingredient(s) added successfully! Reloading...`, 'success');
                    await initializeApp(false);
                } else {
                    showToast('No new ingredients were added. Check for duplicates or invalid formatting.', 'error');
                }
                document.getElementById('bulk-ingredients-cost-input').value = '';
            } catch (error) {
                showToast(`Error adding ingredients: ${error.message}`, 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }
        
        function handleBulkIngredients() {
            const text = document.getElementById('bulk-ingredients-input').value;
            const container = document.getElementById('formulation-ingredients-container');
            if (!text || !container) return;

            const emptyRow = container.querySelector('.formulation-ingredient-row');
            if (emptyRow && !emptyRow.querySelector('.ingredient-selector').value) {
                emptyRow.remove();
            }
            
            const entries = text.split(',').map(s => s.trim()).filter(Boolean);
            let notFound = [];
            
            entries.forEach(entry => {
                const match = entry.match(/^(.*?)\s*([\d\.]+)\s*(\w+)$/);
                if (!match) return;

                const [, name, quantity, unit] = match;
                const foundIngredient = state.ingredients.find(ing => ing.Name && ing.Name.toLowerCase() === name.trim().toLowerCase());

                if (foundIngredient) {
                    addFormulationIngredientRow({ id: foundIngredient.ID, quantity: quantity, unit: unit.trim() });
                } else { notFound.push(name.trim()); }
            });

            if (notFound.length > 0) {
                showToast(`Ingredients not found: ${notFound.join(', ')}. Please add them first.`, 'error');
            }
            document.getElementById('bulk-ingredients-input').value = '';
            updateFormulationCost();
        }

        function addFormulationIngredientRow(ingredient = null) {
            const container = document.getElementById('formulation-ingredients-container');
            if (!container) return;
            const opts = state.ingredients.map(ing => `<option value="${ing.ID}" data-cost="${ing.Cost}" data-unit="${ing.Unit}">${ing.Name}</option>`).join('');
            const row = document.createElement('div');
            row.className = 'flex items-center space-x-2 formulation-ingredient-row';
            row.innerHTML = `<select class="ingredient-selector flex-grow p-2 border rounded-md bg-white"><option value="">Select ingredient</option>${opts}</select><input type="number" step="any" class="ingredient-quantity w-24 p-2 border rounded-md" placeholder="Qty"><select class="ingredient-unit-selector w-20 p-2 border rounded-md bg-white"><option>ml</option><option>L</option><option>gm</option><option>kg</option></select><button type="button" data-action="remove-ingredient-row" class="text-red-500 font-bold">&times;</button>`;
            container.appendChild(row);
            if(ingredient){ 
                row.querySelector('.ingredient-selector').value = ingredient.id; 
                row.querySelector('.ingredient-quantity').value = ingredient.quantity; 
                row.querySelector('.ingredient-unit-selector').value = ingredient.unit;
            }
        }
        function updateFormulationCost() { 
            const ingredients = [...document.querySelectorAll('.formulation-ingredient-row')].map(r => {
                const selector = r.querySelector('.ingredient-selector');
                if (!selector || selector.value === "") return null;
                return { id: selector.value, quantity: r.querySelector('.ingredient-quantity').value, unit: r.querySelector('.ingredient-unit-selector').value };
            }).filter(Boolean);
            
            const total = calculateFormulationCost(ingredients);
            document.getElementById('formulation-total-cost').textContent = `${CURRENCY_SYMBOL}${total.toFixed(2)}`;
        }

        function handlePhotoSelection(event) { state.photoQueue = [...event.target.files]; if(state.photoQueue.length > 0) processPhotoQueue(); }
        function processPhotoQueue() { if (state.photoQueue.length === 0) return; const file = state.photoQueue.shift(); const reader = new FileReader(); reader.onload = e => openCropper(e.target.result); reader.readAsDataURL(file); }
        function openCropper(imageData) { imageToCrop.src = imageData; cropperModal.style.display = 'block'; if(cropper) cropper.destroy(); cropper = new Cropper(imageToCrop, { viewMode: 0, autoCrop: false, background: false, movable: true, zoomable: true, scalable: true, rotatable: true }); }
        function cropAndSaveImage() { const croppedCanvas = cropper.getCroppedCanvas(); const croppedImageData = croppedCanvas.toDataURL('image/jpeg', 0.9); state.croppedPhotosData.push({ fileData: croppedImageData, fileName: `cropped_image_${Date.now()}.jpg`, mimeType: 'image/jpeg', label: '' }); updatePhotoPreview(); closeCropper(); }
        function closeCropper() { if(cropper) cropper.destroy(); cropper = null; cropperModal.style.display = 'none'; if (state.photoQueue.length > 0) processPhotoQueue(); }
        function updatePhotoPreview() { const previewContainer = document.getElementById('photo-preview'); if(!previewContainer) return; previewContainer.innerHTML = ''; state.croppedPhotosData.forEach((data, index) => { const wrapper = document.createElement('div'); wrapper.className = 'relative'; wrapper.innerHTML = `<img src="${data.fileData}" class="h-24 w-24 object-cover rounded-md border"><input type="text" data-index="${index}" class="photo-label-input absolute bottom-0 left-0 w-full text-xs p-1 bg-black bg-opacity-50 text-white" placeholder="Label..." value="${data.label || ''}"><button data-action="remove-photo" data-index="${index}" class="absolute top-0 right-0 bg-red-500 text-white rounded-full h-5 w-5 flex items-center justify-center text-xs font-bold">&times;</button>`; previewContainer.appendChild(wrapper); }); }
        
        async function uploadPhotos(photosData) {
            if (!photosData.length) return [];
            const uploadPromises = photosData.map(photoData => apiCall('uploadPhoto', photoData, false));
            const results = await Promise.all(uploadPromises);
            return results.filter(result => result && result.url).map((result, index) => ({
                url: result.url,
                label: photosData[index].label
            }));
        }

        async function fetchWeather() {
            const form = document.getElementById('trial-form');
            if (!form) return;
            showToast('Fetching weather for your location...', 'success');

            const fillWeatherData = async (lat, lon) => {
                try {
                    const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,rain,wind_speed_10m`);
                    if (!response.ok) throw new Error('Could not fetch weather data.');
                    const weather = await response.json();
                    const current = weather.current;
                    
                    form.querySelector('[name="temperature"]').value = current.temperature_2m;
                    form.querySelector('[name="humidity"]').value = current.relative_humidity_2m;
                    form.querySelector('[name="windspeed"]').value = current.wind_speed_10m;
                    form.querySelector('[name="rain"]').value = current.rain;
                    showToast('Weather data populated.', 'success');
                } catch (error) {
                    console.error("Weather fetch error:", error);
                    showToast(error.message, 'error');
                }
            };
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        fillWeatherData(position.coords.latitude, position.coords.longitude);
                    },
                    (error) => {
                        console.warn("Geolocation error:", error.message);
                        showToast('Could not get location. Using default.', 'error');
                        fillWeatherData(12.97, 77.59); // Default to Bengaluru
                    }
                );
            } else {
                showToast('Geolocation not supported. Using default.', 'error');
                fillWeatherData(12.97, 77.59); // Default to Bengaluru
            }
        }

        function getImageAsBase64(url) { return new Promise((resolve) => { const img = new Image(); img.crossOrigin = 'Anonymous'; img.onload = () => { const canvas = document.createElement('canvas'); canvas.width = img.width; canvas.height = img.height; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0); resolve(canvas.toDataURL('image/jpeg')); }; img.onerror = () => { console.error('Could not load image for PDF:', url); resolve(null); }; img.src = `https://images.weserv.nl/?url=${encodeURIComponent(url)}`; });}
        
        function updateOrganiseBar() {
            const bar = document.getElementById('organise-bar');
            const countEl = document.getElementById('selected-trials-count');
            if (!bar || !countEl) return;
            if (state.selectedTrials.length > 0) {
                countEl.textContent = `${state.selectedTrials.length} trial(s) selected`;
                bar.classList.remove('hidden');
            } else {
                bar.classList.add('hidden');
            }
        }
        
        function exportJson() {
            const dataToExport = {
                ingredients: state.ingredients,
                formulations: state.formulations,
                trials: state.trials,
                organisations: state.organisations,
                exportedAt: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `herbicide_data_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('JSON export started.');
        }

        async function exportWithPhotos() {
            loadingOverlay.classList.remove('hidden');
            showToast('Preparing ZIP export...', 'success');
            const zip = new JSZip();
            const dataToExport = { ingredients: state.ingredients, formulations: state.formulations, trials: state.trials, organisations: state.organisations };
            zip.file("data.json", JSON.stringify(dataToExport, null, 2));
            const photoFolder = zip.folder("photos");
            const photoPromises = [];

            state.trials.forEach(trial => {
                const photos = JSON.parse(trial.PhotoURLs || '[]')
                photos.forEach(photo => {
                    if (photo.url) {
                        const fileName = photo.url.substring(photo.url.lastIndexOf('=') + 1) + ".jpg";
                        photoPromises.push(
                            fetch(`https://images.weserv.nl/?url=${encodeURIComponent(photo.url)}`)
                            .then(res => res.blob())
                            .then(blob => photoFolder.file(fileName, blob))
                            .catch(err => console.error("Failed to fetch image for ZIP:", err))
                        );
                    }
                });
            });

            await Promise.all(photoPromises);
            zip.generateAsync({ type: "blob" }).then(content => {
                const url = URL.createObjectURL(content);
                const a = document.createElement('a');
                a.href = url;
                a.download = `herbicide_data_with_photos_${new Date().toISOString().split('T')[0]}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('ZIP file download started.');
                loadingOverlay.classList.add('hidden');
            });
        }
        
        function importJson() {
            const fileInput = document.getElementById('import-file-input');
            if (!fileInput.files.length) return showToast('Please select a file to import.', 'error');
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.ingredients || !data.formulations || !data.trials) { throw new Error('Invalid backup file format.'); }
                    
                    showConfirmation('Overwrite Data?', 'Importing this file will overwrite all current data. Continue?', async () => {
                        loadingOverlay.classList.remove('hidden');
                        try {
                            await clearAllData(false);
                            for (const item of data.ingredients) { await apiCall('addIngredient', item, false); }
                            for (const item of data.formulations) { await apiCall('addFormulation', { ...item, ingredients: JSON.parse(item.IngredientsJSON || '[]') }, false); }
                            for (const item of data.trials) { await apiCall('addTrial', item, false); }
                            if (data.organisations && data.organisations.length > 0) {
                                for (const item of data.organisations) { await apiCall('addOrganisation', { ...item, trialIds: JSON.parse(item.TrialIDs || '[]') }, false); }
                            }
                            await initializeApp(false);
                            showToast('Data imported successfully!', 'success');
                        } catch (error) {
                            showToast(`Import failed: ${error.message}`, 'error');
                            await initializeApp(false); 
                        } finally {
                            loadingOverlay.classList.add('hidden');
                        }
                    });
                } catch (error) { showToast(`Import failed: ${error.message}`, 'error'); }
            };
            reader.readAsText(file);
        }

        async function clearAllData(confirm = true) {
            const clearAction = async () => {
                loadingOverlay.classList.remove('hidden');
                showToast('Deleting all data...', 'success');
                for (const id of (state.organisations || []).map(o => o.ID)) { await apiCall('deleteOrganisation', { id }, false); }
                for (const id of (state.trials || []).map(t => t.ID)) { await apiCall('deleteTrial', { id }, false); }
                for (const id of (state.formulations || []).map(f => f.ID)) { await apiCall('deleteFormulation', { id }, false); }
                for (const id of (state.ingredients || []).map(i => i.ID)) { await apiCall('deleteIngredient', { id }, false); }
                
                state = { ...state, trials: [], formulations: [], ingredients: [], organisations: [] };
                switchPage(state.currentPage);
                showToast('All data has been cleared.', 'success');
                loadingOverlay.classList.add('hidden');
            };

            if (confirm) {
                showConfirmation('Clear All Data?', 'This will permanently delete everything. Are you sure?', clearAction);
            } else {
                await clearAction();
            }
        }
        
        async function generateTrialPdf(trialId, options = {}) {
            const { withIngredients = false, orientation = 'p' } = options;
            const trial = state.trials.find(t => t.ID === trialId);
            if (!trial) return;
            showToast('Generating PDF...', 'success');
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation });

            const primaryColor = [22, 160, 133];
            const secondaryColor = [44, 62, 80];
            let finalY = 0;

            doc.setFillColor(...primaryColor);
            doc.rect(0, 0, doc.internal.pageSize.width, 25, 'F');
            doc.setFontSize(22);
            doc.setTextColor(255, 255, 255);
            doc.setFont(undefined, 'bold');
            doc.text("Herbicide Trial Report", doc.internal.pageSize.width / 2, 15, { align: 'center' });
            
            doc.setFontSize(16);
            doc.setTextColor(...secondaryColor);
            doc.text(trial.FormulationName, 14, 35);

            const trialBody = [
                [{content: 'Investigator:', styles: {fontStyle: 'bold'}}, trial.InvestigatorName || 'N/A'],
                [{content: 'Date:', styles: {fontStyle: 'bold'}}, new Date(trial.Date).toLocaleDateString()],
                [{content: 'Dosage:', styles: {fontStyle: 'bold'}}, trial.Dosage || 'N/A'],
                [{content: 'Weed Species:', styles: {fontStyle: 'bold'}}, trial.WeedSpecies || 'N/A'],
            ];
             const weatherBody = [
                [{content: 'Temperature:', styles: {fontStyle: 'bold'}}, `${trial.Temperature || 'N/A'}Â°C`],
                [{content: 'Humidity:', styles: {fontStyle: 'bold'}}, `${trial.Humidity || 'N/A'}%`],
                [{content: 'Wind:', styles: {fontStyle: 'bold'}}, `${trial.Windspeed || 'N/A'} km/h`],
                [{content: 'Rain:', styles: {fontStyle: 'bold'}}, `${trial.Rain || 'N/A'} mm`],
            ];

            doc.autoTable({
                startY: 42,
                head: [['Trial Information', '']],
                body: trialBody,
                theme: 'striped',
                columnStyles: { 0: { cellWidth: 40 } },
                headStyles: { fillColor: secondaryColor },
                didDrawPage: (data) => { finalY = data.cursor.y; }
            });
            
            if (trial.Temperature) {
                 doc.autoTable({
                    startY: finalY + 2,
                    head: [['Weather Conditions', '']],
                    body: weatherBody,
                    theme: 'striped',
                    columnStyles: { 0: { cellWidth: 40 } },
                    headStyles: { fillColor: secondaryColor },
                    didDrawPage: (data) => { finalY = data.cursor.y; }
                });
            }

            const addTextBlock = (title, content) => {
                finalY += 10;
                doc.setFontSize(14);
                doc.setTextColor(...secondaryColor);
                doc.text(title, 14, finalY);
                finalY += 6;
                doc.setFontSize(10);
                doc.setTextColor(80);
                const splitText = doc.splitTextToSize(String(content || 'N/A'), doc.internal.pageSize.width - 28);
                doc.text(splitText, 14, finalY);
                finalY += (splitText.length * 4) + 5;
            };
            
            addTextBlock('Conclusion', trial.Conclusion);
            addTextBlock('Notes', trial.Notes);

            if (withIngredients) {
                const formulation = state.formulations.find(f => f.ID === trial.FormulationID);
                if (formulation && formulation.IngredientsJSON) {
                    const ingredients = JSON.parse(formulation.IngredientsJSON || '[]');
                    if (ingredients.length > 0) {
                        doc.autoTable({
                            startY: finalY + 5,
                            head: [['Ingredient', 'Quantity', 'Unit']],
                            body: ingredients.map(ing => [String(ing.name), String(ing.quantity), String(ing.unit)]),
                            theme: 'grid',
                            headStyles: { fillColor: primaryColor },
                             didDrawPage: (data) => { finalY = data.cursor.y; }
                        });
                    } else {
                         doc.text('No ingredients listed for this formulation.', 14, finalY + 10);
                         finalY += 15;
                    }
                } else {
                    doc.text('Ingredient details for this formulation are not available.', 14, finalY + 10);
                    finalY += 15;
                }
            }

            const photos = JSON.parse(trial.PhotoURLs || '[]');
            if (photos.length > 0) {
                finalY += 10;
                doc.setFontSize(14);
                doc.setTextColor(...secondaryColor);
                doc.text('Photos', 14, finalY);
                finalY += 8;

                const photoWidth = 85;
                const photoHeight = 65;
                let xPos = 14;

                for (const photo of photos) {
                    if (photo.url) {
                        const imgData = await getImageAsBase64(photo.url);
                        if (imgData) {
                            if (finalY + photoHeight > doc.internal.pageSize.height - 20) {
                                doc.addPage();
                                finalY = 20;
                            }
                            doc.addImage(imgData, 'JPEG', xPos, finalY, photoWidth, photoHeight);
                            doc.setFontSize(9);
                            doc.setTextColor(100);
                            doc.text(photo.label || '', xPos + photoWidth / 2, finalY + photoHeight + 4, { align: 'center' });
                           
                            xPos += photoWidth + 5;
                            if (xPos + photoWidth > doc.internal.pageSize.width - 14) {
                                xPos = 14;
                                finalY += photoHeight + 15;
                            }
                        }
                    }
                }
            }

            const pageCount = doc.internal.getNumberOfPages();
            for(let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.width / 2, doc.internal.pageSize.height - 10, { align: 'center' });
            }


            doc.save(`Trial_${trial.FormulationName}_${trial.Date}.pdf`);
        }
        
        async function exportToPpt(trialId) {
            const trial = state.trials.find(t => t.ID === trialId);
            if (!trial) return;
            showToast('Generating PPTX...', 'success');
            let pptx = new PptxGenJS();
            
            let titleSlide = pptx.addSlide();
            titleSlide.addText(`Herbicide Trial Report: ${trial.FormulationName}`, { x: 0.5, y: 1, w: '90%', h: 1, fontSize: 24, bold: true, align: 'center' });
            titleSlide.addText(`Date: ${new Date(trial.Date).toLocaleDateString()}`, { x: 0.5, y: 2, w: '90%', h: 1, fontSize: 18, align: 'center' });

            let dataSlide = pptx.addSlide();
            dataSlide.addText('Trial Details', { x: 0.5, y: 0.25, w: 5, h: 0.5, fontSize: 18, bold: true });
            const data = [
                { text: 'Investigator: ', bold: true }, { text: trial.InvestigatorName || 'N/A' },
                { text: 'Dosage: ', bold: true, breakLine: true }, { text: trial.Dosage || 'N/A' },
                { text: 'Weed Species: ', bold: true, breakLine: true }, { text: trial.WeedSpecies || 'N/A' },
                { text: 'Conclusion: ', bold: true, breakLine: true }, { text: trial.Conclusion || 'N/A' },
            ];
            dataSlide.addText(data, { x: 0.5, y: 1, w: '90%', h: 4, fontSize: 14 });

            const photos = JSON.parse(trial.PhotoURLs || '[]');
            for (const photo of photos) {
                if (photo.url) {
                    const imgData = await getImageAsBase64(photo.url);
                    if (imgData) {
                        let photoSlide = pptx.addSlide();
                        photoSlide.addText(photo.label || 'Trial Photo', { x: 0.5, y: 0.25, w: '90%', h: 0.5, fontSize: 18, bold: true, align: 'center' });
                        photoSlide.addImage({ data: imgData, x: 1, y: 1, w: 8, h: 4.5 });
                    }
                }
            }
            
            pptx.writeFile({ fileName: `Trial_${trial.FormulationName}_${trial.Date}.pptx` });
        }


        async function handleAiQuery(query) {
            if (!state.geminiApiKey) { appendMessageToChat('Please add your Gemini API Key in the Settings page to use the AI Assistant.', 'ai'); return; }
            appendMessageToChat(query, 'user');
            const context = `TRIAL DATA:\n${state.trials.map(t => `- Trial with ${t.FormulationName} against ${t.WeedSpecies} on ${t.Date}. Investigator: ${t.InvestigatorName}. Notes: ${t.Conclusion}`).join('\n')}`;
            const prompt = `You are a helpful AI assistant for a herbicide trial manager. Your primary role is to answer questions based on the provided trial data. If the user asks a question that can be answered from the data, use it. If the user's query is a simple greeting (like "hi", "hello"), a general knowledge question, a question about current events (like today's date), or something that cannot be answered by the provided data, use your search tool to find the answer. Be conversational and friendly.\n\nHere is the trial data:\n${context}\n\nUser's question: "${query}"`;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${state.geminiApiKey}`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: prompt }] }],
                        tools: [{ "google_search": {} }]
                    }) 
                });
                if (!response.ok) { const err = await response.json(); throw new Error(err.error.message || 'Unknown API Error'); }
                const result = await response.json();
                if(!result.candidates || !result.candidates[0].content) throw new Error("Invalid response from AI.");
                const text = result.candidates[0].content.parts[0].text;
                appendMessageToChat(text.replace(/\n/g, '<br>'), 'ai');
            } catch (error) { console.error("AI Error:", error); appendMessageToChat(`Sorry, an error occurred: ${error.message}`, 'ai'); }
        }
        function appendMessageToChat(text, sender) { const chatBox = document.getElementById('ai-chat-box'); if (!chatBox) return; const msgDiv = document.createElement('div'); msgDiv.innerHTML = text; msgDiv.className = `${sender}-message p-3 rounded-lg max-w-xl`; chatBox.appendChild(msgDiv); chatBox.scrollTop = chatBox.scrollHeight; }
        
        function bindEventListeners() {
            document.querySelector('nav').addEventListener('click', e => { if (e.target.matches('.nav-link')) { e.preventDefault(); switchPage(e.target.dataset.page); } });
            document.body.addEventListener('click', e => {
                const target = e.target.closest('[data-action]');
                if (!target) return;
                
                if (target.dataset.action === 'edit' || target.dataset.action === 'delete' || target.dataset.action.startsWith('export')) {
                    e.stopPropagation(); 
                }

                const { action, type, id, index } = target.dataset;
                const actions = {
                    openModal: () => handleOpenModal(type),
                    'open-organise-modal': () => openModal('organise'),
                    'fetch-weather': fetchWeather,
                    edit: () => handleEdit(type, id),
                    delete: () => handleDelete(type, id),
                    'view-trial': () => openTrialDetail(id),
                    'export-pdf-with-ingredients': () => generateTrialPdf(id, { withIngredients: true }),
                    'export-pdf-without-ingredients': () => generateTrialPdf(id, { withIngredients: false }),
                    'export-pdf-landscape': () => generateTrialPdf(id, { orientation: 'l' }),
                    'export-ppt': () => exportToPpt(id),
                    'export-json': exportJson,
                    'export-zip': exportWithPhotos,
                    'import-json': importJson,
                    'clear-data': () => clearAllData(true),
                    'add-ingredient-row': addFormulationIngredientRow,
                    'apply-bulk-add': handleBulkIngredients,
                    'apply-bulk-add-cost': handleBulkIngredientsCost,
                    'close-modal': closeModal,
                    'cancel-crop': closeCropper,
                    'crop-image': cropAndSaveImage,
                    'remove-ingredient-row': () => { target.closest('.formulation-ingredient-row').remove(); updateFormulationCost(); },
                    'remove-photo': () => { state.croppedPhotosData.splice(index, 1); updatePhotoPreview(); },
                    'reset-data-sources': () => {
                        localStorage.removeItem('appSettings');
                        loadSettings();
                        showToast('Data sources reset to default.');
                        initializeApp();
                    }
                };
                if (actions[action]) {
                     e.preventDefault();
                     actions[action]();
                } else if (action && !action.startsWith('confirm')) {
                    console.warn(`No action handler for: ${action}`);
                }
            });
            document.body.addEventListener('input', e => {
                const target = e.target;
                 if (target.id === 'import-file-input') {
                    document.querySelector('[data-action="import-json"]').disabled = !target.files.length;
                }
                if (target.matches('[data-action="filter"]')) applyFilters();
                if (target.matches('[data-action="select-trial"]')) {
                    const { id } = target.dataset;
                    if (target.checked) {
                        if (!state.selectedTrials.includes(id)) state.selectedTrials.push(id);
                    } else {
                        state.selectedTrials = state.selectedTrials.filter(trialId => trialId !== id);
                    }
                    updateOrganiseBar();
                }
                if (target.id === 'trial-photos') handlePhotoSelection(e);
                if (target.matches('.photo-label-input')) state.croppedPhotosData[target.dataset.index].label = target.value;
                if (target.closest('#formulation-form')) updateFormulationCost();
            });
            document.body.addEventListener('submit', e => {
                e.preventDefault();
                handleFormSubmit(e.target);
            });
        }
        
        function normalizeIDs(dataArray) {
            if (!Array.isArray(dataArray)) return [];
            return dataArray.map(item => {
                const newItem = { ...item };
                if (newItem.ID !== undefined && newItem.ID !== null) newItem.ID = String(newItem.ID);
                if (newItem.FormulationID !== undefined && newItem.FormulationID !== null) newItem.FormulationID = String(newItem.FormulationID);
                return newItem;
            });
        }

        function loadSettings() {
            const savedSettings = localStorage.getItem('appSettings');
            if (savedSettings) {
                state.settings = JSON.parse(savedSettings);
            } else {
                state.settings = { scriptUrl: DEFAULT_SCRIPT_URL, sheetId: null, folderId: null };
            }
        }
        
        function handleDataSourceSave(form) {
            const scriptUrl = form.querySelector('#script-url').value.trim();
            const sheetUrl = form.querySelector('#sheet-url').value.trim();
            const folderUrl = form.querySelector('#folder-url').value.trim();

            const sheetId = (sheetUrl.match(/spreadsheets\/d\/([a-zA-Z0-9-_]+)/) || [])[1] || null;
            const folderId = (folderUrl.match(/folders\/([a-zA-Z0-9-_]+)/) || [])[1] || null;

            if(!scriptUrl) return showToast('Apps Script URL is required.', 'error');
            
            state.settings = { scriptUrl, sheetId, folderId };
            localStorage.setItem('appSettings', JSON.stringify(state.settings));
            showToast('Data sources saved! Reloading app...');
            setTimeout(() => window.location.reload(), 1500);
        }
        
        function handleCredentialResponse(response) {
            // User has successfully signed in. Now show them the next step to grant permissions.
            document.getElementById('google-signin-button').classList.add('hidden');
            document.getElementById('setup-section').classList.remove('hidden');
            showToast('Successfully signed in! Please click below to create your backend.', 'success');
        }

        function createBackend() {
            // This function is now the trigger for the permission request popup.
            const tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.profile',
                callback: async (tokenResponse) => {
                    // This callback runs after the user interacts with the popup.
                    if (tokenResponse && tokenResponse.access_token) {
                        state.auth.token = tokenResponse.access_token;
                        
                        // Now that we have the token, proceed with creating the backend files.
                        showToast('Permissions granted! Creating your personal backend...', 'success');
                        loadingOverlay.classList.remove('hidden');
                        try {
                            const result = await apiCall('createNewBackend', { accessToken: state.auth.token }, false);
                            if (result && result.newSheetId && result.newFolderId) {
                                state.settings = {
                                    scriptUrl: state.settings.scriptUrl,
                                    sheetId: result.newSheetId,
                                    folderId: result.newFolderId
                                };
                                localStorage.setItem('appSettings', JSON.stringify(state.settings));
                                showToast('Backend created successfully! Reloading app...', 'success');
                                setTimeout(() => window.location.reload(), 2000);
                            } else {
                                throw new Error('Failed to get new file IDs from the server.');
                            }
                        } catch (error) {
                            console.error('Backend creation failed:', error);
                            showToast(error.message, 'error');
                        } finally {
                            loadingOverlay.classList.add('hidden');
                        }

                    } else {
                        showToast('Authorization failed. Could not get permission to access Google Drive.', 'error');
                    }
                },
            });

            // This triggers the Google popup. Because it's called directly from the button's click handler, it won't be blocked.
            tokenClient.requestAccessToken();
        }

        async function initializeApp(showOverlay = true) {
            if(showOverlay) loadingOverlay.classList.remove('hidden');
            try {
                loadSettings();
                
                if (!state.settings.sheetId || !state.settings.folderId) {
                    appContainer.classList.add('hidden');
                    onboardingContainer.classList.remove('hidden');
                    
                    const signInButtonContainer = document.getElementById('google-signin-button');

                    // Check if the app is being run from a local file path
                    if (window.location.protocol === 'file:') {
                        signInButtonContainer.innerHTML = `
                            <div class="p-4 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-lg text-left">
                                <p class="font-bold mb-2">How to Run This App</p>
                                <p class="text-sm">Google Sign-In cannot work when you open the HTML file directly from your computer.</p>
                                <p class="text-sm mt-2">Please run this app from a web server or use the <strong>'Preview'</strong> feature in your development environment to get a valid web address (URL).</p>
                            </div>
                        `;
                         loadingOverlay.classList.add('hidden');
                        return;
                    }

                    // Removed the large troubleshooting HTML block for a cleaner UI

                    if (GOOGLE_CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID_HERE' || GOOGLE_CLIENT_ID.length < 20) {
                        signInButtonContainer.innerHTML = `
                            <div class="p-4 bg-red-100 text-red-800 rounded-lg text-left">
                                <p class="font-bold mb-2">Configuration Required</p>
                                <p class="text-sm">Please set your Google Client ID in the HTML file to enable sign-in.</p>
                            </div>
                        `;
                    } else if (typeof google !== 'undefined') {
                        google.accounts.id.initialize({ client_id: GOOGLE_CLIENT_ID, callback: handleCredentialResponse });
                        google.accounts.id.renderButton(signInButtonContainer, { theme: "outline", size: "large", width: "100%" });
                    }
                    loadingOverlay.classList.add('hidden');
                    return; 
                }
                
                appContainer.classList.remove('hidden');
                onboardingContainer.classList.add('hidden');
                
                state.geminiApiKey = localStorage.getItem('geminiApiKey') || '';
                
                const allData = await apiCall('getAllData', {}, false);

                if (allData === null) {
                    mainContent.innerHTML = `<div class="text-center p-8 bg-white rounded-lg shadow"><p class="text-red-500 font-semibold">Could not load application data.</p><p class="text-gray-600 mt-2">Please check your connection and refresh the page. If the problem persists, ensure your Data Source URLs are correct in the Settings page.</p></div>`;
                    return;
                }
                
                state.ingredients = normalizeIDs(allData.ingredients || []);
                state.formulations = normalizeIDs(allData.formulations || []);
                state.trials = normalizeIDs(allData.trials || []);
                state.organisations = normalizeIDs(allData.organisations || []);

                switchPage(state.currentPage || 'formulations');
            } catch (error) {
                console.error("Initialization failed:", error);
                mainContent.innerHTML = `<div class="text-center p-8 bg-white rounded-lg shadow"><p class="text-red-500 font-semibold">A critical error occurred during startup.</p><p class="text-gray-600 mt-2">Please check the console for details and refresh the page.</p></div>`;
            } finally {
                if(showOverlay) loadingOverlay.classList.add('hidden');
            }
        }
        
        // --- INITIALIZATION ---
        document.getElementById('create-backend-button').addEventListener('click', createBackend);
        document.getElementById('go-to-settings-button').addEventListener('click', () => {
            appContainer.classList.remove('hidden');
            onboardingContainer.classList.add('hidden');
            switchPage('settings');
        });

        bindEventListeners();
        initializeApp();
    });
    </script>
</body>
</html>











