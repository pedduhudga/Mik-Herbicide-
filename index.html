<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herbicide Trial Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .nav-link { transition: all 0.2s ease-in-out; border-bottom: 2px solid transparent; padding-top: 1rem; padding-bottom: 1rem; cursor: pointer; }
        .nav-link.active { border-bottom-color: #3b82f6; color: #3b82f6; font-weight: 600; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.5); animation: fadeIn 0.3s; }
        #cropper-modal, #camera-modal { z-index: 1050; }
        .modal-content { animation: slideIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-30px); opacity: 0; } to { translateY(0); opacity: 1; } }
        .toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 2000; left: 50%; bottom: 30px; font-size: 17px; opacity: 0; transition: visibility 0.5s, opacity 0.5s linear; }
        .toast.show { visibility: visible; opacity: 1; }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        #cropper-container > img { max-width: 100%; max-height: 70vh; }
        #camera-modal video { width: 100%; max-height: 70vh; border-radius: 8px; background-color: #000;}
        #ai-chat-box { height: calc(100vh - 25rem); }
        .ai-message { background-color: #e5e7eb; }
        .user-message { background-color: #dbeafe; align-self: flex-end; }
        .result-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: transparent;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
        }
        .result-excellent, .result-select.result-excellent { background-color: #d1fae5; color: #065f46; }
        .result-good, .result-select.result-good { background-color: #dbeafe; color: #1e40af; }
        .result-fair, .result-select.result-fair { background-color: #fef3c7; color: #92400e; }
        .result-poor, .result-select.result-poor { background-color: #fee2e2; color: #991b1b; }
        .result-select.result-none { background-color: #e5e7eb; color: #4b5563; }
        .quick-add-btn {
            background-color: #e5e7eb;
            color: #374151;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .quick-add-btn:hover { background-color: #d1d5db; }
    </style>
</head>
<body class="antialiased">
    <!-- CONFIGURATION -->
    <script>
        const DEFAULT_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwtaa-hUhgzGuhI9dY9ymvg8nExhNUIdcTSzWmJwGh0YKw0lZ7ceJqs0HYI1lSX30bx/exec';
        const CURRENCY_SYMBOL = 'â‚¹';
    </script>
    <!-- App Container -->
    <div class="min-h-screen bg-gray-100">
        <header class="bg-white shadow-sm"><div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center"><h1 class="text-2xl font-bold text-gray-800">Herbicide Trial Manager</h1></div></header>
        <nav class="bg-white border-b border-gray-200"><div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"><div class="flex items-center space-x-8 -mb-px">
            <a class="nav-link active text-sm font-medium" data-page="formulations">Formulations</a>
            <a class="nav-link text-sm font-medium" data-page="trials">Trials</a>
            <a class="nav-link text-sm font-medium" data-page="organisations">Organisations</a>
            <a class="nav-link text-sm font-medium" data-page="ingredients">Ingredient Costs</a>
            <a class="nav-link text-sm font-medium" data-page="aiAssistant">AI Assistant</a>
            <a class="nav-link text-sm font-medium" data-page="dataMgmt">Data Mgmt</a>
            <a class="nav-link text-sm font-medium" data-page="settings">Settings</a>
        </div></div></nav>
        <main id="main-content" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"></main>
    </div>
    <!-- Modals & Overlays -->
    <div id="modal-container"></div>
    <div id="cropper-modal" class="modal"><div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-4xl mx-auto mt-10"><h3 class="text-lg font-bold mb-4">Crop Image</h3><div id="cropper-container" class="mb-4 bg-gray-200"><img id="image-to-crop"></div><div class="flex justify-end space-x-3"><button data-action="cancel-crop" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button><button data-action="crop-image" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Crop & Save Image</button></div></div></div>
    <div id="camera-modal" class="modal"><div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl mx-auto mt-10"><h3 class="text-lg font-bold mb-4">Live Camera</h3><video id="camera-stream" autoplay playsinline></video><canvas id="camera-canvas" class="hidden"></canvas><div class="mt-4 flex justify-end space-x-3"><button data-action="close-camera" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg">Cancel</button><button data-action="capture-photo" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Capture Photo</button></div></div></div>
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center hidden"><div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white"></div></div>
    <div id="toast" class="toast"></div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        let state = { 
            currentPage: 'formulations', 
            ingredients: [], 
            formulations: [], 
            trials: [], 
            organisations: [], 
            selectedTrials: [], 
            photoQueue: [], 
            croppedPhotosData: [], 
            currentTrialIdForCamera: null,
            geminiApiKey: '',
            aiChatHistory: [],
            settings: {
                scriptUrl: DEFAULT_SCRIPT_URL,
                sheetId: null,
                folderId: null
            }
        };
        const mainContent = document.getElementById('main-content');
        const modalContainer = document.getElementById('modal-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        const toast = document.getElementById('toast');
        const cropperModal = document.getElementById('cropper-modal');
        const imageToCrop = document.getElementById('image-to-crop');
        const cameraModal = document.getElementById('camera-modal');
        const videoElement = document.getElementById('camera-stream');
        const canvasElement = document.getElementById('camera-canvas');
        let cropper = null;
        let cameraStream = null;

        const templates = {
            page: (pageId) => ({
                formulations: `<div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4"><div><h2 class="text-xl font-semibold text-gray-700">My Formulations</h2></div><div class="flex-grow"><input type="search" data-action="filter" data-type="formulation" placeholder="Search formulations by name..." class="w-full px-4 py-2 border rounded-lg"></div><div><button data-action="openModal" data-type="formulation" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition w-full md:w-auto">+ Add New Formulation</button></div></div><div id="formulations-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>`,
                trials: `<div class="bg-white p-4 rounded-lg shadow-md mb-6"><div class="flex justify-between items-center"><h3 class="font-semibold text-gray-800 mb-2">Filters & Sorting</h3><div class="flex gap-2"><button data-action="sort-trials" data-sort="date" class="text-sm bg-gray-200 px-3 py-1 rounded-md">Sort by Date</button><button data-action="sort-trials" data-sort="result" class="text-sm bg-gray-200 px-3 py-1 rounded-md">Sort by Result</button></div></div><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4"><input type="search" data-action="filter" data-type="trial-search" placeholder="Search investigator, species..." class="w-full px-4 py-2 border rounded-lg"><select data-action="filter" data-type="trial-formulation" class="p-2 border rounded-lg bg-white"><option value="">Filter by Formulation</option></select><div class="grid grid-cols-2 gap-2"><input type="date" data-action="filter" data-type="trial-start-date" class="p-2 border rounded-lg" title="Start Date"><input type="date" data-action="filter" data-type="trial-end-date" class="p-2 border rounded-lg" title="End Date"></div></div></div><div class="flex justify-end mb-6"><button data-action="openModal" data-type="trial" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition w-full sm:w-auto">+ Log New Trial</button></div><div id="trials-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div><div id="organise-bar" class="hidden fixed bottom-10 left-1/2 -translate-x-1/2 bg-gray-800 text-white py-3 px-6 rounded-lg shadow-lg flex items-center gap-4 z-20"><span id="selected-trials-count"></span><button data-action="open-organise-modal" class="bg-indigo-500 hover:bg-indigo-600 px-4 py-2 rounded-md text-sm font-semibold">Add to Organisation</button></div>`,
                organisations: `<div class="flex justify-between items-center mb-6"><div><h2 class="text-xl font-semibold text-gray-700">Trial Organisations</h2><p class="text-sm text-gray-500">Group trials together for easier analysis.</p></div></div><div id="organisations-list" class="space-y-8"></div>`,
                ingredients: `<div class="bg-white p-6 rounded-lg shadow mb-8"><h3 class="text-lg font-medium text-gray-800">Bulk Add Ingredients</h3><p class="text-sm text-gray-500 mb-2">Enter multiple ingredients in the format: Name Cost Unit, ... (e.g., Glyphosate 15000 L, Paraquat 8000 kg)</p><div class="flex gap-2"><textarea id="bulk-ingredients-cost-input" placeholder="IngredientA 100 kg, IngredientB 50 L" class="w-full p-2 border border-gray-300 rounded-md" rows="4"></textarea><button type="button" data-action="apply-bulk-add-cost" class="bg-indigo-600 text-white px-4 py-2 rounded-lg self-start">Add Bulk</button></div></div><div class="flex justify-between items-center mb-6"><h2 class="text-xl font-semibold text-gray-700">Ingredient Costs</h2><button data-action="openModal" data-type="ingredient" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition">+ Add New Cost</button></div><div id="ingredients-list" class="bg-white p-6 rounded-lg shadow"></div>`,
                aiAssistant: `<div class="bg-white p-6 rounded-lg shadow">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-xl font-semibold text-gray-700">AI Assistant</h2>
                                    <button data-action="clear-chat" class="text-sm bg-gray-200 px-3 py-1 rounded-md hover:bg-gray-300">Clear History</button>
                                </div>
                                <div id="ai-chat-box" class="border rounded-lg p-4 overflow-y-auto mb-4 bg-gray-50 flex flex-col gap-2"></div>
                                <form id="ai-form" class="flex gap-4">
                                    <input type="text" id="ai-input" placeholder="E.g., Which formulation had the best result?" class="flex-grow p-2 border rounded-lg" required>
                                    <button type="submit" class="bg-blue-600 text-white px-5 py-2 rounded-lg">Send</button>
                                </form>
                              </div>`,
                dataMgmt: `<div class="space-y-8"><div><h2 class="text-xl font-semibold text-gray-700 mb-4">Export Data</h2><div class="bg-white p-6 rounded-lg shadow"><p class="text-gray-600 mb-4">Download all your data as a JSON file for backup or as a ZIP with photos.</p><div class="flex gap-4"><button data-action="export-json" class="bg-green-600 text-white px-4 py-2 rounded-lg">Export to JSON</button><button data-action="export-zip" class="bg-green-700 text-white px-4 py-2 rounded-lg">Export with Photos</button></div></div></div><div><h2 class="text-xl font-semibold text-gray-700 mb-4">Import Data</h2><div class="bg-white p-6 rounded-lg shadow"><p class="text-gray-600 mb-4">Upload a previously exported JSON file to restore your data. <strong class="text-red-600">This will overwrite all current data.</strong></p><input type="file" id="import-file-input" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" accept=".json"><button data-action="import-json" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg" disabled>Import from JSON</button></div></div><div><h2 class="text-xl font-semibold text-gray-700 mb-4">Clear All Data</h2><div class="bg-white p-6 rounded-lg shadow border-red-300"><p class="text-gray-600 mb-4">Permanently delete all your data. <strong class="text-red-600">This action cannot be undone.</strong></p><button data-action="clear-data" class="bg-red-600 text-white px-4 py-2 rounded-lg">Clear All Data</button></div></div></div>`,
                settings: `<div class="bg-white p-6 rounded-lg shadow space-y-8">
                                <div>
                                    <h2 class="text-xl font-semibold text-gray-700 mb-4">AI Assistant</h2>
                                    <p class="text-sm text-gray-600 mb-2">Enter your Google Gemini API Key below to enable the AI Assistant.</p>
                                    <form id="settings-form" class="flex items-end gap-4"><div class="flex-grow"><label for="gemini-api-key" class="block text-sm font-medium text-gray-700">Gemini API Key</label><input type="password" id="gemini-api-key" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div><button type="submit" class="bg-blue-600 text-white px-5 py-2 rounded-lg">Save Key</button></form>
                                </div>
                                <div class="border-t pt-8">
                                    <h3 class="text-lg font-medium text-gray-900">Data Source Settings</h3>
                                    <p class="mt-1 text-sm text-gray-600">For multi-user support, you can connect the app to your own Google Sheet and Drive folder.</p>
                                    <form id="data-source-form" class="mt-4 space-y-4">
                                        <div>
                                            <label for="script-url" class="block text-sm font-medium text-gray-700">Apps Script Web App URL</label>
                                            <input type="url" id="script-url" placeholder="Paste the full URL of your deployed Apps Script" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                        </div>
                                        <div>
                                            <label for="sheet-url" class="block text-sm font-medium text-gray-700">Google Sheet URL</label>
                                            <input type="url" id="sheet-url" placeholder="Paste the full URL of your Google Sheet copy" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                        </div>
                                        <div>
                                            <label for="folder-url" class="block text-sm font-medium text-gray-700">Google Drive Photo Folder URL</label>
                                            <input type="url" id="folder-url" placeholder="Paste the full URL of your photo folder" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                        </div>
                                        <div class="flex items-center justify-between pt-2">
                                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Save Data Sources</button>
                                            <button type="button" data-action="reset-data-sources" class="text-sm text-gray-500 hover:text-gray-700">Reset to Default</button>
                                        </div>
                                    </form>
                                </div>
                                <div class="border-t pt-8">
                                    <h3 class="text-lg font-medium text-gray-900">Troubleshooting</h3>
                                     <p class="mt-1 text-sm text-gray-600">If you are experiencing issues, clear the application cache and perform a hard reload.</p>
                                     <div class="mt-4">
                                        <button data-action="force-reload" class="bg-red-600 text-white px-4 py-2 rounded-lg">Clear Cache & Reload App</button>
                                     </div>
                                </div>
                           </div>`,
            })[pageId] || '',
            modal: (modalId, isEdit = false, data = {}) => {
                const modalTemplates = {
                    ingredient: `<div id="ingredient-modal" class="modal"><div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-auto mt-20"><h3 class="text-lg font-bold mb-4">${isEdit ? 'Edit' : 'Add'} Ingredient</h3><form id="ingredient-form"><input type="hidden" name="id"><div class="mb-4"><label class="block text-sm font-medium text-gray-700">Ingredient Name</label><input type="text" name="name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700">Cost</label><input type="number" name="cost" step="0.01" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div><div><label class="block text-sm font-medium text-gray-700">Base Unit</label><select name="unit" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white"><option value="L">L</option><option value="kg">kg</option><option value="ml">ml</option><option value="gm">gm</option></select></div></div><div class="mt-6 flex justify-end space-x-3"><button type="button" data-action="close-modal" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg">Cancel</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Save</button></div></form></div></div>`,
                    formulation: `<div id="formulation-modal" class="modal"><div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl mx-auto mt-10"><h3 class="text-lg font-bold mb-4">${isEdit ? 'Edit' : 'Add'} Formulation</h3><form id="formulation-form"><input type="hidden" name="id"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><input type="text" name="name" required placeholder="Formulation Name" class="p-2 border border-gray-300 rounded-md"><input type="text" name="notes" placeholder="Notes" class="p-2 border border-gray-300 rounded-md"></div><div class="mt-6"><h4 class="text-md font-medium text-gray-800">Bulk Add Ingredients</h4><p class="text-sm text-gray-500 mb-2">Enter ingredients in the format: Name QuantityUnit, ...</p><div class="flex gap-2"><textarea id="bulk-ingredients-input" placeholder="Pelargonic Acid 50ML, Capric Acid 20ML" class="w-full p-2 border border-gray-300 rounded-md" rows="3"></textarea><button type="button" data-action="apply-bulk-add" class="bg-indigo-600 text-white px-4 py-2 rounded-lg self-start">Add</button></div></div><div class="mt-6"><h4 class="text-md font-medium text-gray-800">Ingredients</h4><div id="formulation-ingredients-container" class="mt-2 space-y-3"></div><button type="button" data-action="add-ingredient-row" class="mt-3 text-sm text-blue-600 hover:text-blue-800">+ Add Another Ingredient</button></div><div class="mt-6 border-t pt-4"><p class="font-semibold">Total Cost: <span id="formulation-total-cost">${CURRENCY_SYMBOL}0.00</span></p></div><div class="mt-6 flex justify-end space-x-3"><button type="button" data-action="close-modal" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg">Cancel</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Save</button></div></form></div></div>`,
                    trial: `<div id="trial-modal" class="modal"><div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-3xl mx-auto mt-10"><h3 class="text-lg font-bold mb-4">${isEdit ? 'Edit' : 'Log'} Trial</h3><form id="trial-form"><input type="hidden" name="id"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><input type="text" name="investigatorName" required placeholder="Investigator Name" class="p-2 border border-gray-300 rounded-md" list="investigator-list"><datalist id="investigator-list"></datalist><select name="formulationId" id="trial-formulation" required class="p-2 border border-gray-300 rounded-md bg-white"></select><input type="text" name="dosage" placeholder="Dosage" class="p-2 border border-gray-300 rounded-md"><input type="text" name="weedSpecies" placeholder="Weed Species" class="p-2 border border-gray-300 rounded-md"><input type="date" name="date" id="trial-date" required class="p-2 border border-gray-300 rounded-md"><select name="result" class="p-2 border border-gray-300 rounded-md bg-white"><option value="">Select Result</option><option value="Excellent">Excellent</option><option value="Good">Good</option><option value="Fair">Fair</option><option value="Poor">Poor</option></select><div class="md:col-span-2 flex items-center gap-2"><input type="checkbox" id="control-finalized" name="controlFinalized" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"><label for="control-finalized" class="text-sm text-gray-700">Mark final control day (stops counting)</label></div></div><div class="mt-6 p-4 bg-gray-50 rounded-lg"><div class="flex justify-between items-center mb-2"><h4 class="text-md font-medium text-gray-800">Weather Conditions</h4><button type="button" data-action="fetch-weather" class="text-sm text-blue-600 hover:text-blue-800 font-semibold">Fetch Current Weather</button></div><div class="grid grid-cols-2 md:grid-cols-4 gap-4"><input type="text" name="temperature" placeholder="Temp (Â°C)" class="p-2 border border-gray-300 rounded-md text-sm"><input type="text" name="humidity" placeholder="Humidity (%)" class="p-2 border border-gray-300 rounded-md text-sm"><input type="text" name="windspeed" placeholder="Wind (km/h)" class="p-2 border border-gray-300 rounded-md text-sm"><input type="text" name="rain" placeholder="Rain (mm)" class="p-2 border border-gray-300 rounded-md text-sm"></div></div><div class="mt-6 grid grid-cols-1 gap-6"><textarea name="conclusion" rows="3" placeholder="Conclusion" class="p-2 border border-gray-300 rounded-md"></textarea><textarea name="notes" rows="2" placeholder="Trial Notes" class="p-2 border border-gray-300 rounded-md"></textarea></div><div class="mt-6"><label class="block text-sm font-medium text-gray-700">Add & Crop Photos</label><div class="flex items-center gap-4 mt-2"><input type="file" id="trial-photos" multiple accept="image/*" class="hidden"><label for="trial-photos" class="cursor-pointer bg-white text-blue-700 px-4 py-2 rounded-lg border border-blue-700 hover:bg-blue-50 text-sm font-semibold">Choose Files</label><button type="button" data-action="open-camera" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm font-semibold">Open Camera</button></div><div id="photo-preview" class="mt-2 flex flex-wrap gap-4"></div></div><div class="mt-6 flex justify-end space-x-3"><button type="button" data-action="close-modal" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg">Cancel</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Save</button></div></form></div></div>`,
                    confirm: `<div id="confirm-modal" class="modal"><div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-sm mx-auto mt-20"><h3 id="confirm-title" class="text-lg font-bold mb-4">Are you sure?</h3><p id="confirm-message" class="text-gray-600 mb-6">This action cannot be undone.</p><div class="flex justify-end space-x-3"><button data-action="confirm-cancel" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg">Cancel</button><button data-action="confirm-ok" class="bg-red-600 text-white px-4 py-2 rounded-lg">Confirm</button></div></div></div>`,
                    trialDetail: () => {
                        const { trial } = data;
                        if (!trial) return '';
                        const photos = JSON.parse(trial.PhotoURLs || '[]').map(p => {
                            const proxiedUrl = p.url ? `https://images.weserv.nl/?url=${encodeURIComponent(p.url)}` : '';
                            return `<figure class="text-center"><a href="${p.url}" target="_blank"><img src="${proxiedUrl}" class="h-48 w-auto object-cover rounded-md border"></a><figcaption class="text-sm text-gray-600 mt-1">${p.label || ''}</figcaption></figure>`
                        }).join('');

                        return `<div id="trial-detail-modal" class="modal"><div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-5xl mx-auto mt-10"><h3 class="text-2xl font-bold mb-6">Herbicide Trial Report: ${trial.FormulationName}</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div class="space-y-2 text-gray-800"><p><strong>Investigator:</strong> ${trial.InvestigatorName || 'N/A'}</p><p><strong>Dosage:</strong> ${trial.Dosage || 'N/A'}</p><p><strong>Weed Species:</strong> ${trial.WeedSpecies || 'N/A'}</p><p><strong>Date:</strong> ${new Date(trial.Date).toLocaleDateString()}</p><p><strong>Result:</strong> ${trial.Result || 'N/A'}</p>${ trial.Temperature ? `<div class="mt-4 pt-4 border-t"><p class="font-semibold text-gray-500 text-sm">Weather Conditions</p><p><strong>Temperature:</strong> ${trial.Temperature}Â°C</p><p><strong>Humidity:</strong> ${trial.Humidity}%</p><p><strong>Wind:</strong> ${trial.Windspeed} km/h</p><p><strong>Rain:</strong> ${trial.Rain} mm</p></div>` : '' }<div class="mt-4 pt-4 border-t"><p><strong>Conclusion:</strong> ${trial.Conclusion || 'N/A'}</p><p><strong>Notes:</strong> ${trial.Notes || 'N/A'}</p></div></div><div><h4 class="text-lg font-semibold mb-2">Photos</h4><div class="flex flex-wrap gap-4">${photos || 'No photos available.'}</div></div></div><div class="mt-8 border-t pt-6 flex flex-wrap justify-center gap-3"><button data-action="export-pdf-with-ingredients" data-id="${trial.ID}" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg text-sm">Export as PDF with Ingredients</button><button data-action="export-pdf-without-ingredients" data-id="${trial.ID}" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg text-sm">Export as PDF without Ingredients</button><button data-action="export-pdf-landscape" data-id="${trial.ID}" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg text-sm">Download as PDF Landscape</button><button data-action="export-ppt" data-id="${trial.ID}" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg text-sm">Export as PPT</button><button data-action="close-modal" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">Go Back</button></div></div></div>`;
                    },
                    organise: `<div id="organise-modal" class="modal"><div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-auto mt-20"><h3 class="text-lg font-bold mb-4">Add to Organisation</h3><form id="organise-form"><div class="mb-4"><label class="block text-sm font-medium text-gray-700">Select Existing Organisation</label><select name="organisationId" id="existing-organisations" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"><option value="">-- Choose existing --</option>${state.organisations.map(o => `<option value="${o.ID}">${o.Name}</option>`).join('')}</select></div><div class="text-center my-2 text-gray-500">OR</div><div class="mb-4"><label class="block text-sm font-medium text-gray-700">Create New Organisation</label><input type="text" name="newOrganisationName" placeholder="e.g., Summer 2025 Variants" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div><div class="mt-6 flex justify-end space-x-3"><button type="button" data-action="close-modal" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg">Cancel</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Save</button></div></form></div></div>`
                };
                const template = modalTemplates[modalId];
                if (typeof template === 'function') {
                    return template();
                }
                return template || '';
            }
        };

        const render = {
            trialCard: (trial, showCheckbox = false) => {
                const formulation = state.formulations.find(f => f.ID === trial.FormulationID);
                const cost = formulation ? parseFloat(formulation.EstimatedCost || 0).toFixed(2) : '0.00';
                let controlDuration;
                if (trial.ControlFinalized && trial.FinalControlDuration != null) {
                    controlDuration = `${trial.FinalControlDuration} Days (Final)`;
                } else if (trial.Date) {
                    const days = Math.floor((new Date() - new Date(trial.Date)) / (1000 * 60 * 60 * 24));
                    controlDuration = `${days < 0 ? 0 : days} Days`;
                } else {
                    controlDuration = 'N/A';
                }
                const photos = JSON.parse(trial.PhotoURLs || '[]').slice(0, 4).map(p => { // Show max 4 thumbnails
                    const photoUrl = p.url || p; // Handle both object and string array for optimistic updates
                    const proxiedUrl = photoUrl.startsWith('data:image') ? photoUrl : `https://images.weserv.nl/?url=${encodeURIComponent(photoUrl)}&w=100&h=100&fit=cover`;
                    return `<img src="${proxiedUrl}" class="h-16 w-16 object-cover rounded-md border" alt="${p.label || 'Trial photo'}">`
                }).join('');

                const resultValue = trial.Result || '';
                const resultSelect = `
                    <select data-action="update-result" data-id="${trial.ID}" class="result-select result-${resultValue.toLowerCase() || 'none'}" onchange="this.className = 'result-select result-' + (this.value.toLowerCase() || 'none')">
                        <option value="" ${resultValue === '' ? 'selected' : ''}>Set Result</option>
                        <option value="Excellent" ${resultValue === 'Excellent' ? 'selected' : ''}>Excellent</option>
                        <option value="Good" ${resultValue === 'Good' ? 'selected' : ''}>Good</option>
                        <option value="Fair" ${resultValue === 'Fair' ? 'selected' : ''}>Fair</option>
                        <option value="Poor" ${resultValue === 'Poor' ? 'selected' : ''}>Poor</option>
                    </select>
                `;

                return `
                <div class="bg-white p-4 rounded-lg shadow-md flex flex-col h-full">
                    <div class="flex items-start gap-4">
                        ${showCheckbox ? `<input type="checkbox" data-action="select-trial" data-id="${trial.ID}" class="mt-1 h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">` : ''}
                        <div class="flex-grow">
                            <div class="flex justify-between items-start">
                                <div class="flex-grow cursor-pointer" data-action="view-trial" data-id="${trial.ID}">
                                    <h3 class="font-bold text-lg">${trial.FormulationName || 'Unknown Formulation'}</h3>
                                </div>
                                <div class="flex flex-col items-end gap-2 ml-4">
                                    <button data-action="edit" data-type="trial" data-id="${trial.ID}" class="text-blue-600 hover:text-blue-800 font-semibold text-sm px-3 py-1">Edit</button>
                                    <button data-action="delete" data-type="trial" data-id="${trial.ID}" class="text-red-500 hover:text-red-700 font-semibold text-sm px-3 py-1">Delete</button>
                                </div>
                            </div>
                             <div class="mt-2 flex justify-between items-center">
                                ${resultSelect}
                             </div>
                            <div class="grid grid-cols-2 gap-x-4 text-sm text-gray-600 mt-2 cursor-pointer" data-action="view-trial" data-id="${trial.ID}">
                                <p><strong>Dosage:</strong> ${trial.Dosage || 'N/A'}</p>
                                <p class="text-blue-600 font-semibold"><strong>Control:</strong> ${controlDuration}</p>
                                <p><strong>Date:</strong> ${trial.Date ? new Date(trial.Date).toLocaleDateString() : 'N/A'}</p>
                                <p class="font-semibold"><strong>Cost:</strong> ${CURRENCY_SYMBOL}${cost}</p>
                            </div>
                            ${photos ? `<div class="mt-4 cursor-pointer" data-action="view-trial" data-id="${trial.ID}"><div class="flex flex-wrap gap-2">${photos}</div></div>` : ''}
                        </div>
                    </div>
                    <div class="mt-auto pt-4 border-t border-gray-100 flex items-center justify-end gap-2">
                        <input type="file" id="quick-photo-input-${trial.ID}" class="hidden" data-action="quick-add-photo" data-id="${trial.ID}" accept="image/*" multiple>
                        <label for="quick-photo-input-${trial.ID}" class="quick-add-btn cursor-pointer">Add Photo</label>
                        <button class="quick-add-btn" data-action="quick-open-camera" data-id="${trial.ID}">Camera</button>
                    </div>
                </div>`;
            },
            ingredients: (data = state.ingredients) => { const el = document.getElementById('ingredients-list'); if(el) el.innerHTML = `<ul class="divide-y divide-gray-200">${(data || []).map(ing => `<li class="py-3 flex justify-between items-center"><div><p class="font-medium">${ing.Name}</p><p class="text-sm text-gray-500">${CURRENCY_SYMBOL}${parseFloat(ing.Cost).toFixed(2)} / ${ing.Unit}</p></div><div class="flex gap-4"><button data-action="edit" data-type="ingredient" data-id="${ing.ID}" class="text-blue-600 hover:text-blue-800 font-bold">Edit</button><button data-action="delete" data-type="ingredient" data-id="${ing.ID}" class="text-red-500 hover:text-red-700 font-bold">&times;</button></div></li>`).join('') || '<p class="text-gray-500">No ingredients.</p>'}</ul>`; },
            formulations: (data = state.formulations) => { const el = document.getElementById('formulations-list'); if(el) el.innerHTML = (data || []).map(form => `<div class="bg-white p-6 rounded-lg shadow-md relative"><div class="absolute top-4 right-4 flex gap-2"><button data-action="edit" data-type="formulation" data-id="${form.ID}" class="btn-secondary px-3 py-1 rounded-md text-sm">Edit</button><button data-action="delete" data-type="formulation" data-id="${form.ID}" class="text-red-500 font-bold text-xl">&times;</button></div><h3 class="font-bold text-lg">${form.Name}</h3><div class="mt-2 text-sm text-gray-600"><ul class="list-disc list-inside">${JSON.parse(form.IngredientsJSON || '[]').map(ing => `<li>${ing.name} (${ing.quantity} ${ing.unit})</li>`).join('')}</ul>${form.Notes ? `<p class="mt-2"><strong>Notes:</strong> ${form.Notes}</p>` : ''}</div><p class="mt-4 font-semibold">Cost: ${CURRENCY_SYMBOL}${parseFloat(form.EstimatedCost || 0).toFixed(2)}</p></div>`).join('') || '<p class="text-gray-500 col-span-full">No formulations found.</p>'; },
            trials: (data = state.trials) => {
                const el = document.getElementById('trials-list');
                if (!el) return;
                el.innerHTML = (data || []).map(trial => render.trialCard(trial, true)).join('') || '<p class="text-gray-500">No trials found.</p>';
            },
             organisations: (data = state.organisations) => {
                const el = document.getElementById('organisations-list');
                if (!el) return;
                el.innerHTML = (data || []).map(org => {
                    const trialDetails = (JSON.parse(org.TrialIDs || '[]')).map(trialId => state.trials.find(t => t.ID === trialId)).filter(Boolean);
                    return `<div class="bg-white p-6 rounded-lg shadow-md">
                                <div class="flex justify-between items-start mb-4">
                                    <h3 class="font-bold text-xl text-gray-800">${org.Name}</h3>
                                    <button data-action="delete" data-type="organisation" data-id="${org.ID}" class="text-red-500 hover:text-red-700 font-semibold text-sm">Delete</button>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    ${trialDetails.length > 0 ? trialDetails.map(t => render.trialCard(t, false)).join('') : '<p class="text-gray-500 col-span-full">No trials in this organisation.</p>'}
                                </div>
                            </div>`;
                }).join('') || '<p class="text-gray-500">No organisations created yet. Go to the Trials page to group some together.</p>';
            },
        };

        async function apiCall(action, payload = {}, showOverlay = true) {
            if (showOverlay) loadingOverlay.classList.remove('hidden');
            try {
                const fullPayload = { ...payload, spreadsheetId: state.settings.sheetId, folderId: state.settings.folderId };
                const res = await fetch(state.settings.scriptUrl, { method: 'POST', body: JSON.stringify({ action, payload: fullPayload }), redirect: 'follow' });
                if (!res.ok) throw new Error(`Network error: ${res.statusText}`);
                const result = await res.json();
                if (result.status === 'error') {
                    console.error('Server-side error:', result.message, '\nStack:', result.stack);
                    throw new Error(result.message);
                }
                return result.data;
            } catch (error) {
                console.error('API Error:', error);
                // Don't show toast here for optimistic updates, handle it in the calling function
                return null;
            } finally {
                if (showOverlay) loadingOverlay.classList.add('hidden');
            }
        }
        
        function showToast(message, type = 'success') { toast.textContent = message; toast.className = `toast show ${type}`; setTimeout(() => { toast.className = toast.className.replace('show', ''); }, 5000); }
        
        function switchPage(pageId) {
            state.currentPage = pageId;
            document.querySelectorAll('.nav-link').forEach(link => link.classList.toggle('active', link.dataset.page === pageId));
            mainContent.innerHTML = templates.page(pageId);
            
            const renderFn = render[pageId];
            if (renderFn) renderFn(state[pageId]);
            
            if (pageId === 'trials') {
                const filterSelect = mainContent.querySelector('[data-type="trial-formulation"]');
                if (filterSelect) {
                    const formulationNames = [...new Set((state.trials || []).map(t => t.FormulationName).filter(Boolean))].sort();
                    filterSelect.innerHTML = `<option value="">Filter by Formulation</option>${formulationNames.map(name => `<option value="${name}">${name}</option>`).join('')}`;
                }
                state.selectedTrials = [];
                updateOrganiseBar();
            }
             if (pageId === 'settings') {
                document.getElementById('gemini-api-key').value = state.geminiApiKey || '';
                document.getElementById('script-url').value = state.settings.scriptUrl || '';
                document.getElementById('sheet-url').value = state.settings.sheetId ? `https://docs.google.com/spreadsheets/d/${state.settings.sheetId}/` : '';
                document.getElementById('folder-url').value = state.settings.folderId ? `https://drive.google.com/drive/folders/${state.settings.folderId}` : '';
            }
             if (pageId === 'aiAssistant') {
                setTimeout(() => {
                    const chatBox = document.getElementById('ai-chat-box');
                    if (!chatBox) return;
                    chatBox.innerHTML = ''; 
                    if (state.aiChatHistory.length === 0) { appendMessageToChat('Hello! Ask me about your trial data.', 'ai', false); } 
                    else { state.aiChatHistory.forEach(msg => appendMessageToChat(msg.text, msg.sender, false)); }
                }, 0);
            }
        }

        function openModal(id, isEdit = false, data = {}) {
            modalContainer.innerHTML = templates.modal(id, isEdit, data);
            if (modalContainer.firstChild) modalContainer.firstChild.style.display = 'block';
        }
        function closeModal() { modalContainer.innerHTML = ''; }

        function showConfirmation(title, message, onConfirm) {
            openModal('confirm');
            const okBtn = document.querySelector('[data-action="confirm-ok"]');
            const cancelBtn = document.querySelector('[data-action="confirm-cancel"]');
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            
            const cleanup = () => { okBtn.removeEventListener('click', confirmHandler); cancelBtn.removeEventListener('click', cleanup); closeModal(); };
            const confirmHandler = () => { onConfirm(); cleanup(); };
            
            okBtn.addEventListener('click', confirmHandler, { once: true });
            cancelBtn.addEventListener('click', cleanup, { once: true });
        }

        function openTrialDetail(trialId) { const trial = state.trials.find(t => t.ID === trialId); if (trial) openModal('trialDetail', false, { trial }); }

        function handleOpenModal(type) {
            state.croppedPhotosData = []; state.currentTrialIdForCamera = null; openModal(type);
            setTimeout(() => {
                if (type === 'trial') {
                    const form = document.getElementById('trial-form');
                    form.querySelector('#trial-formulation').innerHTML = `<option value="">Select formulation</option>${state.formulations.map(f => `<option value="${f.ID}">${f.Name}</option>`).join('')}`;
                    form.querySelector('#trial-date').valueAsDate = new Date();
                    const investigatorList = document.getElementById('investigator-list');
                    const uniqueInvestigators = [...new Set(state.trials.map(t => t.InvestigatorName).filter(Boolean))];
                    investigatorList.innerHTML = uniqueInvestigators.map(name => `<option value="${name}"></option>`).join('');
                } else if (type === 'formulation') { addFormulationIngredientRow(); }
            }, 50);
        }

        function handleEdit(type, id) {
             state.currentTrialIdForCamera = null;
             const data = state[type + 's'].find(item => item.ID === id);
             if (data) { openModal(type, true); setTimeout(() => populateForm(document.getElementById(`${type}-form`), data), 50); }
        }

        async function handleDelete(type, id) {
             showConfirmation(`Delete this ${type}?`, `This will permanently remove the ${type}.`, () => {
                if (type === 'formulation' && state.trials.some(trial => trial.FormulationID === id)) return showToast('Cannot delete: formulation is in use.', 'error');
                
                const collection = type + 's';
                const originalState = JSON.parse(JSON.stringify(state[collection]));
                state[collection] = state[collection].filter(item => item.ID !== id);
                switchPage(state.currentPage);
                showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} deleted.`, 'success');

                apiCall(`delete${type.charAt(0).toUpperCase() + type.slice(1)}`, { id }, false).then(result => {
                    if (!result) {
                        showToast(`Sync failed for delete. Reverting.`, 'error');
                        state[collection] = originalState;
                        switchPage(state.currentPage);
                    }
                });
            });
        }
        
        function calculateFormulationCost(ingredients) {
            if (!ingredients || !state.ingredients) return 0;
            return ingredients.reduce((acc, currentIng) => {
                const details = state.ingredients.find(i => i.ID === currentIng.id);
                if (!details) return acc;
                const costPerBase = parseFloat(details.Cost);
                if (isNaN(costPerBase)) return acc;
                const baseUnit = details.Unit.toLowerCase(), usedUnit = currentIng.unit.toLowerCase();
                let quantity = parseFloat(currentIng.quantity) || 0;
                if ((baseUnit === 'l' && usedUnit === 'ml') || (baseUnit === 'kg' && usedUnit === 'gm')) quantity /= 1000;
                else if ((baseUnit === 'ml' && usedUnit === 'l') || (baseUnit === 'gm' && usedUnit === 'kg')) quantity *= 1000;
                return acc + (costPerBase * quantity);
            }, 0);
        }
        
        async function handleFormSubmit(form) {
            if (!form) return;
            const formId = form.getAttribute('id'); const type = formId.replace('-form', '');
            if (['settings', 'data-source', 'ai', 'organise'].some(t => formId.startsWith(t))) {
                 if (formId === 'settings-form') { state.geminiApiKey = document.getElementById('gemini-api-key').value; localStorage.setItem('geminiApiKey', state.geminiApiKey); showToast('API Key saved.'); }
                 if (formId === 'data-source-form') { handleDataSourceSave(form); }
                 if (formId === 'ai-form') { handleAiQuery(document.getElementById('ai-input').value); form.reset(); }
                 if (formId === 'organise-form') { handleOrganiseSubmit(form); }
                 return;
            }

            const idInput = form.querySelector('input[name="id"]');
            const id = idInput ? idInput.value : null;
            const isUpdate = !!id;
            let action = isUpdate ? `update${type.charAt(0).toUpperCase() + type.slice(1)}` : `add${type.charAt(0).toUpperCase() + type.slice(1)}`;
            if (type === 'trial' && isUpdate) { action = 'updateTrialRecord'; }
            
            const formData = Object.fromEntries(new FormData(form));
            let localRecord;
            const originalState = JSON.parse(JSON.stringify(state[type + 's']));

            try {
                const tempId = id || `temp_${Date.now()}`;
                if (type === 'formulation') {
                    const ingredients = [...document.querySelectorAll('.formulation-ingredient-row')].map(r => ({ id: r.querySelector('.ingredient-selector').value, name: r.querySelector('.ingredient-selector').selectedOptions[0].text, quantity: r.querySelector('.ingredient-quantity').value, unit: r.querySelector('.ingredient-unit-selector').value })).filter(r => r.id);
                    if (ingredients.length === 0) throw new Error('A formulation must have at least one ingredient.');
                    localRecord = { ID: tempId, Name: formData.name, Notes: formData.notes, IngredientsJSON: JSON.stringify(ingredients), EstimatedCost: calculateFormulationCost(ingredients) };
                } else if (type === 'trial') {
                    const formulation = state.formulations.find(f => f.ID === formData.formulationId);
                    if (!formulation) throw new Error('Please select a valid formulation.');
                    localRecord = {
                        ID: tempId, InvestigatorName: formData.investigatorName, FormulationID: formData.formulationId, FormulationName: formulation.Name, Dosage: formData.dosage,
                        WeedSpecies: formData.weedSpecies, Date: formData.date, Result: formData.result, Conclusion: formData.conclusion, Notes: formData.notes,
                        Temperature: formData.temperature, Humidity: formData.humidity, Windspeed: formData.windspeed, Rain: formData.rain,
                        ControlFinalized: form.querySelector('#control-finalized').checked, PhotoURLs: JSON.stringify(state.croppedPhotosData.map(p => ({ url: p.isExisting ? p.fileData : p.fileData, label: p.label })))
                    };
                } else if (type === 'ingredient') {
                    localRecord = { ID: tempId, Name: formData.name, Cost: formData.cost, Unit: formData.unit };
                } else {
                    throw new Error(`Unknown form type: ${type}`);
                }


                if (isUpdate) {
                    const index = state[type + 's'].findIndex(item => item.ID === id);
                    state[type + 's'][index] = { ...state[type + 's'][index], ...localRecord };
                } else {
                    state[type + 's'].push(localRecord);
                }

                closeModal();
                switchPage(state.currentPage);
                showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} saved! Syncing...`);
                
                // --- Background Sync ---
                let finalPayload = { ...formData };
                if(id) finalPayload.id = id; // Add id for updates
                if (type === 'formulation') finalPayload.ingredients = JSON.parse(localRecord.IngredientsJSON);
                if (type === 'trial') {
                    const newPhotos = state.croppedPhotosData.filter(p => !p.isExisting);
                    const existingPhotos = state.croppedPhotosData.filter(p => p.isExisting).map(p => ({ url: p.fileData, label: p.label }));
                    const uploadedPhotos = await uploadPhotos(newPhotos);
                    finalPayload.photoURLs = [...existingPhotos, ...uploadedPhotos];
                }
                
                const savedRecord = await apiCall(action, finalPayload, false);
                if (!savedRecord) throw new Error(`Server sync failed.`);

                if (!isUpdate) {
                    const tempRecord = state[type + 's'].find(item => item.ID === localRecord.ID);
                    if (tempRecord) tempRecord.ID = savedRecord.ID;
                }
                 // Finalize photo URLs in state and re-render
                if (type === 'trial') {
                    const recordInState = state.trials.find(t => t.ID === (isUpdate ? id : savedRecord.ID));
                    if (recordInState) recordInState.PhotoURLs = JSON.stringify(finalPayload.photoURLs);
                    switchPage('trials');
                }

            } catch (error) {
                console.error(`Save failed for ${type}:`, error);
                showToast(`Save failed: ${error.message}. Reverting.`, 'error');
                state[type + 's'] = originalState;
                switchPage(state.currentPage);
            }
        }


        async function handleOrganiseSubmit(form) {
            const formData = new FormData(form);
            const organisationId = formData.get('organisationId');
            const newOrganisationName = formData.get('newOrganisationName').trim();
            const trialIds = state.selectedTrials;

            if (!organisationId && !newOrganisationName) { return showToast('Please select an existing organisation or create a new one.', 'error'); }
            if (trialIds.length === 0) { return showToast('No trials selected.', 'error'); }

            loadingOverlay.classList.remove('hidden');

            try {
                if (newOrganisationName) {
                    const newOrg = await apiCall('addOrganisation', { name: newOrganisationName, trialIds }, false);
                    if (newOrg) state.organisations.push(newOrg);
                } else {
                    const updatedOrg = await apiCall('updateOrganisation', { id: organisationId, trialIds }, false);
                    if (updatedOrg) {
                        const index = state.organisations.findIndex(o => o.ID === organisationId);
                        const existingTrialIds = JSON.parse(state.organisations[index].TrialIDs || '[]');
                        const newTrialIds = [...new Set([...existingTrialIds, ...trialIds])];
                        state.organisations[index].TrialIDs = JSON.stringify(newTrialIds);
                    }
                }
                closeModal();
                switchPage('trials');
            } catch (error) {
                 showToast(`Error updating organisation: ${error.message}`, 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        function populateForm(form, data) {
             if (!form) return;
             const formId = form.getAttribute('id');
             const idInput = form.querySelector('input[name="id"]');
             if (idInput) idInput.value = data.ID;
             if (formId === 'trial-form') {
                 form.querySelector('[name="investigatorName"]').value = data.InvestigatorName;
                 const formulationSelect = form.querySelector('[name="formulationId"]');
                 formulationSelect.innerHTML = state.formulations.map(f => `<option value="${f.ID}">${f.Name}</option>`).join('');
                 formulationSelect.value = data.FormulationID;
                 form.querySelector('[name="dosage"]').value = data.Dosage;
                 form.querySelector('[name="weedSpecies"]').value = data.WeedSpecies;
                 form.querySelector('[name="date"]').value = new Date(data.Date).toISOString().split('T')[0];
                 form.querySelector('[name="result"]').value = data.Result || '';
                 form.querySelector('#control-finalized').checked = data.ControlFinalized || false;
                 form.querySelector('[name="conclusion"]').value = data.Conclusion;
                 form.querySelector('[name="notes"]').value = data.Notes;
                 form.querySelector('[name="temperature"]').value = data.Temperature || '';
                 form.querySelector('[name="humidity"]').value = data.Humidity || '';
                 form.querySelector('[name="windspeed"]').value = data.Windspeed || '';
                 form.querySelector('[name="rain"]').value = data.Rain || '';
                 state.croppedPhotosData = JSON.parse(data.PhotoURLs || '[]').map((p, i) => ({ fileData: p.url, label: p.label, fileName: `existing_image_${i}.jpg`, isExisting: true }));
                 updatePhotoPreview();
             } else if (formId === 'formulation-form') {
                  form.querySelector('[name="name"]').value = data.Name;
                  form.querySelector('[name="notes"]').value = data.Notes;
                  const ingredients = JSON.parse(data.IngredientsJSON || '[]')
                  document.getElementById('formulation-ingredients-container').innerHTML = '';
                  ingredients.forEach(ing => addFormulationIngredientRow(ing));
                  updateFormulationCost();
             } else if (formId === 'ingredient-form') {
                 form.querySelector('[name="name"]').value = data.Name;
                 form.querySelector('[name="cost"]').value = data.Cost;
                 form.querySelector('[name="unit"]').value = data.Unit;
             }
        }

        function applyFilters(sortConfig = {}) {
            let filteredTrials = [...(state.trials || [])];
            const searchTerm = (document.querySelector('[data-type="trial-search"]') || {}).value || '';
            if (searchTerm) { filteredTrials = filteredTrials.filter(t => (t.InvestigatorName && t.InvestigatorName.toLowerCase().includes(searchTerm.toLowerCase())) || (t.WeedSpecies && t.WeedSpecies.toLowerCase().includes(searchTerm.toLowerCase()))); }
            const formulationFilter = (document.querySelector('[data-type="trial-formulation"]') || {}).value || '';
            if (formulationFilter) { filteredTrials = filteredTrials.filter(t => t.FormulationName === formulationFilter); }
            const startDate = (document.querySelector('[data-type="trial-start-date"]') || {}).value || '';
            if (startDate) { filteredTrials = filteredTrials.filter(t => new Date(t.Date) >= new Date(startDate)); }
            const endDate = (document.querySelector('[data-type="trial-end-date"]') || {}).value || '';
            if (endDate) { filteredTrials = filteredTrials.filter(t => new Date(t.Date) <= new Date(endDate)); }
            if (sortConfig.sortBy) {
                const resultOrder = { 'Excellent': 4, 'Good': 3, 'Fair': 2, 'Poor': 1 };
                if (sortConfig.sortBy === 'result') { filteredTrials.sort((a, b) => (resultOrder[b.Result] || 0) - (resultOrder[a.Result] || 0)); } 
                else if (sortConfig.sortBy === 'date') { filteredTrials.sort((a, b) => new Date(b.Date) - new Date(a.Date)); }
            }
            render.trials(filteredTrials);
        }
        
        function handleBulkIngredients() {
            const text = document.getElementById('bulk-ingredients-input').value; const container = document.getElementById('formulation-ingredients-container');
            if (!text || !container) return; const emptyRow = container.querySelector('.formulation-ingredient-row');
            if (emptyRow && !emptyRow.querySelector('.ingredient-selector').value) { emptyRow.remove(); }
            const entries = text.split(',').map(s => s.trim()).filter(Boolean); let notFound = [];
            entries.forEach(entry => {
                const match = entry.match(/^(.*?)\s*([\d\.]+)\s*(\w+)$/); if (!match) return; const [, name, quantity, unit] = match;
                const foundIngredient = state.ingredients.find(ing => ing.Name && ing.Name.toLowerCase() === name.trim().toLowerCase());
                if (foundIngredient) { addFormulationIngredientRow({ id: foundIngredient.ID, quantity: quantity, unit: unit.trim() }); } else { notFound.push(name.trim()); }
            });
            if (notFound.length > 0) { showToast(`Ingredients not found: ${notFound.join(', ')}. Please add them first.`, 'error'); }
            document.getElementById('bulk-ingredients-input').value = ''; updateFormulationCost();
        }
        
        async function handleBulkIngredientsCost() {
            const text = document.getElementById('bulk-ingredients-cost-input').value; if (!text) return showToast('Input cannot be empty.', 'error');
            loadingOverlay.classList.remove('hidden');
            try {
                const entries = text.split(',').map(s => s.trim()).filter(Boolean); if (entries.length === 0) throw new Error("No valid entries.");
                let addedCount = 0;
                for (const entry of entries) {
                    const match = entry.match(/^(.*?)\s+([\d\.]+)\s+(\w+)$/); if (!match) continue; const [, name, cost, unit] = match.map(s => s.trim());
                    if (state.ingredients.some(ing => ing.Name && ing.Name.toLowerCase() === name.toLowerCase())) continue;
                    const newIngredient = await apiCall('addIngredient', { name, cost, unit }, false);
                    if (newIngredient) { state.ingredients.push(newIngredient); addedCount++; }
                }
                if (addedCount > 0) { showToast(`${addedCount} new ingredient(s) added!`, 'success'); switchPage('ingredients'); } 
                else { showToast('No new ingredients were added. Check duplicates or format.', 'error'); }
                document.getElementById('bulk-ingredients-cost-input').value = '';
            } catch (error) { showToast(`Error: ${error.message}`, 'error'); } finally { loadingOverlay.classList.add('hidden'); }
        }

        function addFormulationIngredientRow(ingredient = null) {
            const container = document.getElementById('formulation-ingredients-container'); if (!container) return;
            const opts = state.ingredients.map(ing => `<option value="${ing.ID}" data-cost="${ing.Cost}" data-unit="${ing.Unit}">${ing.Name}</option>`).join('');
            const row = document.createElement('div'); row.className = 'flex items-center space-x-2 formulation-ingredient-row';
            row.innerHTML = `<select class="ingredient-selector flex-grow p-2 border rounded-md bg-white"><option value="">Select ingredient</option>${opts}</select><input type="number" step="any" class="ingredient-quantity w-24 p-2 border rounded-md" placeholder="Qty"><select class="ingredient-unit-selector w-20 p-2 border rounded-md bg-white"><option>ml</option><option>L</option><option>gm</option><option>kg</option></select><button type="button" data-action="remove-ingredient-row" class="text-red-500 font-bold">&times;</button>`;
            container.appendChild(row);
            if(ingredient){ row.querySelector('.ingredient-selector').value = ingredient.id; row.querySelector('.ingredient-quantity').value = ingredient.quantity; row.querySelector('.ingredient-unit-selector').value = ingredient.unit; }
        }
        function updateFormulationCost() { 
            const ingredients = [...document.querySelectorAll('.formulation-ingredient-row')].map(r => { const selector = r.querySelector('.ingredient-selector'); if (!selector || selector.value === "") return null; return { id: selector.value, quantity: r.querySelector('.ingredient-quantity').value, unit: r.querySelector('.ingredient-unit-selector').value }; }).filter(Boolean);
            document.getElementById('formulation-total-cost').textContent = `${CURRENCY_SYMBOL}${calculateFormulationCost(ingredients).toFixed(2)}`;
        }

        function handlePhotoSelection(event) { state.photoQueue = [...event.target.files]; if(state.photoQueue.length > 0) processPhotoQueue(); }
        function processPhotoQueue() { if (state.photoQueue.length === 0) { if (state.currentTrialIdForCamera) { state.currentTrialIdForCamera = null; } return; }; const file = state.photoQueue.shift(); const reader = new FileReader(); reader.onload = e => openCropper(e.target.result); reader.readAsDataURL(file); }
        function openCropper(imageData) { imageToCrop.src = imageData; cropperModal.style.display = 'block'; if(cropper) cropper.destroy(); cropper = new Cropper(imageToCrop, { viewMode: 0, autoCrop: false, background: false, movable: true, zoomable: true, scalable: true, rotatable: true }); }
        
        async function cropAndSaveImage() { 
            const croppedImageData = cropper.getCroppedCanvas().toDataURL('image/jpeg', 0.9); 
            const photoData = { fileData: croppedImageData, fileName: `cropped_${Date.now()}.jpg`, mimeType: 'image/jpeg', label: '' };
            if (state.currentTrialIdForCamera) { const trialId = state.currentTrialIdForCamera; closeCropper(); await handleQuickPhotoAdd(trialId, [photoData]); } 
            else { state.croppedPhotosData.push(photoData); updatePhotoPreview(); closeCropper(); }
        }

        function closeCropper() { if(cropper) cropper.destroy(); cropper = null; cropperModal.style.display = 'none'; if (state.photoQueue.length > 0) processPhotoQueue(); else { state.currentTrialIdForCamera = null; } }
        
        function updatePhotoPreview() {
            const previewContainer = document.getElementById('photo-preview'); if (!previewContainer) return;
            previewContainer.innerHTML = '';
            state.croppedPhotosData.forEach((data, index) => {
                const wrapper = document.createElement('div'); wrapper.className = 'relative';
                const imgSrc = data.isExisting ? `https://images.weserv.nl/?url=${encodeURIComponent(data.fileData)}` : data.fileData;
                wrapper.innerHTML = `<img src="${imgSrc}" class="h-24 w-24 object-cover rounded-md border"><input type="text" data-index="${index}" class="photo-label-input absolute bottom-0 left-0 w-full text-xs p-1 bg-black bg-opacity-50 text-white" placeholder="Label..." value="${data.label || ''}"><button data-action="remove-photo" data-index="${index}" class="absolute top-0 right-0 bg-red-500 text-white rounded-full h-5 w-5 flex items-center justify-center text-xs font-bold">&times;</button>`;
                previewContainer.appendChild(wrapper);
            });
        }
        
        async function uploadPhotos(photosData) {
            if (!photosData.length) return [];
            const results = await Promise.all(photosData.map(photoData => apiCall('uploadPhoto', photoData, false)));
            return results.filter(r => r && r.url).map((result, index) => ({ url: result.url, label: photosData[index].label }));
        }

        async function handleQuickPhotoAdd(trialId, photosData) {
            showToast(`Adding ${photosData.length} photo(s)...`);
            const trialIndex = state.trials.findIndex(t => t.ID === trialId);
            if (trialIndex === -1) return showToast('Trial not found locally.', 'error');
            const originalTrial = JSON.parse(JSON.stringify(state.trials[trialIndex]));
            const existingPhotos = JSON.parse(originalTrial.PhotoURLs || '[]');
            const newPhotosForUI = photosData.map(p => ({ url: p.fileData, label: p.label }));
            state.trials[trialIndex].PhotoURLs = JSON.stringify([...existingPhotos, ...newPhotosForUI]);
            switchPage('trials');
            try {
                const uploadedPhotoURLs = await uploadPhotos(photosData);
                if (uploadedPhotoURLs.length === 0) throw new Error("Photo upload failed.");
                const finalPhotos = [...existingPhotos, ...uploadedPhotoURLs];
                state.trials[trialIndex].PhotoURLs = JSON.stringify(finalPhotos);
                const result = await apiCall('appendPhotosToTrial', { id: trialId, photoURLs: uploadedPhotoURLs }, false);
                if (!result) throw new Error("Server failed to save photos.");
                showToast('Photo(s) added successfully!', 'success');
                switchPage('trials');
            } catch (error) {
                showToast(`Error adding photo: ${error.message}`, 'error');
                state.trials[trialIndex] = originalTrial;
                switchPage('trials');
            } finally {
                state.currentTrialIdForCamera = null;
            }
        }
        
        async function openCamera(trialId = null) {
            state.currentTrialIdForCamera = trialId;
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) { return showToast("Camera not supported on this browser.", "error"); }
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                videoElement.srcObject = cameraStream;
                cameraModal.style.display = 'block';
            } catch (err) {
                console.error("Camera Error:", err);
                let message = "Could not access camera.";
                if (err.name === "NotAllowedError") { message = "Camera access was denied. Check browser permissions."; } 
                else if (err.name === "NotFoundError") { message = "No camera found on this device."; }
                showToast(message, 'error');
                state.currentTrialIdForCamera = null;
            }
        }
        function closeCamera() { if (cameraStream) { cameraStream.getTracks().forEach(track => track.stop()); } cameraModal.style.display = 'none'; }
        function capturePhoto() {
            canvasElement.width = videoElement.videoWidth; canvasElement.height = videoElement.videoHeight;
            canvasElement.getContext('2d').drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
            closeCamera(); openCropper(canvasElement.toDataURL('image/jpeg', 0.9));
        }

        async function fetchWeather() {
            const form = document.getElementById('trial-form'); if (!form) return; showToast('Fetching weather...');
            const fill = async (lat, lon) => {
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,rain,wind_speed_10m`);
                    if (!res.ok) throw new Error('Could not fetch weather.');
                    const { current } = await res.json();
                    form.querySelector('[name="temperature"]').value = current.temperature_2m;
                    form.querySelector('[name="humidity"]').value = current.relative_humidity_2m;
                    form.querySelector('[name="windspeed"]').value = current.wind_speed_10m;
                    form.querySelector('[name="rain"]').value = current.rain;
                    showToast('Weather data populated.', 'success');
                } catch (e) { showToast(e.message, 'error'); }
            };
            if (navigator.geolocation) { navigator.geolocation.getCurrentPosition(pos => fill(pos.coords.latitude, pos.coords.longitude), () => { showToast('Could not get location. Using default.', 'error'); fill(12.97, 77.59); }); } 
            else { showToast('Geolocation not supported.', 'error'); fill(12.97, 77.59); }
        }

        function getImageAsBase64(url) { return new Promise((resolve) => { const img = new Image(); img.crossOrigin = 'Anonymous'; img.onload = () => { const canvas = document.createElement('canvas'); canvas.width = img.width; canvas.height = img.height; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0); resolve(canvas.toDataURL('image/jpeg')); }; img.onerror = () => { console.error('Could not load image for PDF:', url); resolve(null); }; img.src = `https://images.weserv.nl/?url=${encodeURIComponent(url)}`; });}
        
        function updateOrganiseBar() {
            const bar = document.getElementById('organise-bar'); const countEl = document.getElementById('selected-trials-count'); if (!bar || !countEl) return;
            if (state.selectedTrials.length > 0) { countEl.textContent = `${state.selectedTrials.length} trial(s) selected`; bar.classList.remove('hidden'); } 
            else { bar.classList.add('hidden'); }
        }
        
        function exportJson() {
            const data = { ingredients: state.ingredients, formulations: state.formulations, trials: state.trials, organisations: state.organisations, exportedAt: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `herbicide_backup_${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showToast('JSON export started.');
        }

        async function exportWithPhotos() {
            loadingOverlay.classList.remove('hidden'); showToast('Preparing ZIP export...', 'success');
            const zip = new JSZip(); zip.file("data.json", JSON.stringify({ ingredients: state.ingredients, formulations: state.formulations, trials: state.trials, organisations: state.organisations }, null, 2));
            const photoFolder = zip.folder("photos"); const promises = [];
            state.trials.forEach(trial => JSON.parse(trial.PhotoURLs || '[]').forEach(photo => { if (photo.url) { const fileName = photo.url.substring(photo.url.lastIndexOf('=') + 1) + ".jpg"; promises.push( fetch(`https://images.weserv.nl/?url=${encodeURIComponent(photo.url)}`).then(res => res.blob()).then(blob => photoFolder.file(fileName, blob)).catch(err => console.error("ZIP fetch error:", err)) ); } }));
            await Promise.all(promises);
            zip.generateAsync({ type: "blob" }).then(content => { const url = URL.createObjectURL(content); const a = document.createElement('a'); a.href = url; a.download = `herbicide_backup_with_photos_${new Date().toISOString().split('T')[0]}.zip`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showToast('ZIP download started.'); loadingOverlay.classList.add('hidden'); });
        }
        
        function importJson() {
            const file = document.getElementById('import-file-input').files[0]; if (!file) return showToast('Please select a file.', 'error');
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result); if (!data.ingredients || !data.formulations || !data.trials) throw new Error('Invalid backup file.');
                    showConfirmation('Overwrite All Data?', 'Importing will overwrite all current data. Continue?', async () => {
                        loadingOverlay.classList.remove('hidden');
                        try {
                            await clearAllData(false);
                            for (const item of data.ingredients) await apiCall('addIngredient', item, false);
                            for (const item of data.formulations) await apiCall('addFormulation', { ...item, ingredients: JSON.parse(item.IngredientsJSON || '[]') }, false);
                            for (const item of data.trials) await apiCall('addTrial', item, false);
                            if (data.organisations) for (const item of data.organisations) await apiCall('addOrganisation', { ...item, trialIds: JSON.parse(item.TrialIDs || '[]') }, false);
                            await initializeApp(false);
                            showToast('Data imported successfully!', 'success');
                        } catch (error) { showToast(`Import failed: ${error.message}`, 'error'); await initializeApp(false); } 
                        finally { loadingOverlay.classList.add('hidden'); }
                    });
                } catch (error) { showToast(`Import failed: ${error.message}`, 'error'); }
            };
            reader.readAsText(file);
        }

        async function clearAllData(confirm = true) {
            const clearAction = async () => {
                loadingOverlay.classList.remove('hidden'); showToast('Deleting all data...');
                await Promise.all([
                    ...(state.organisations || []).map(o => apiCall('deleteOrganisation', { id: o.ID }, false)), ...(state.trials || []).map(t => apiCall('deleteTrial', { id: t.ID }, false)),
                    ...(state.formulations || []).map(f => apiCall('deleteFormulation', { id: f.ID }, false)), ...(state.ingredients || []).map(i => apiCall('deleteIngredient', { id: i.ID }, false)),
                ]);
                state = { ...state, trials: [], formulations: [], ingredients: [], organisations: [] };
                switchPage(state.currentPage); showToast('All data has been cleared.', 'success'); loadingOverlay.classList.add('hidden');
            };
            if (confirm) { showConfirmation('Clear All Data?', 'This will permanently delete everything. Are you sure?', clearAction); } else { await clearAction(); }
        }
        
        async function generateTrialPdf(trialId, options = {}) {
            const { withIngredients = false, orientation = 'p' } = options; const trial = state.trials.find(t => t.ID === trialId); if (!trial) return; showToast('Generating PDF...');
            const { jsPDF } = window.jspdf; const doc = new jsPDF({ orientation }); const primary = [22, 160, 133], secondary = [44, 62, 80]; let finalY = 0;
            doc.setFillColor(...primary); doc.rect(0, 0, doc.internal.pageSize.width, 25, 'F'); doc.setFontSize(22).setTextColor(255).setFont(undefined, 'bold').text("Herbicide Trial Report", doc.internal.pageSize.width / 2, 15, { align: 'center' });
            doc.setFontSize(16).setTextColor(...secondary).text(trial.FormulationName, 14, 35);
            const trialBody = [
                ['Investigator:', trial.InvestigatorName || 'N/A'],
                ['Date:', new Date(trial.Date).toLocaleDateString()],
                ['Dosage:', trial.Dosage || 'N/A'],
                ['Weed Species:', trial.WeedSpecies || 'N/A'],
                ['Result:', trial.Result || 'N/A'],
            ];
            const weatherBody = [
                ['Temperature:', `${trial.Temperature||'N/A'}Â°C`],
                ['Humidity:', `${trial.Humidity||'N/A'}%`],
                ['Wind:', `${trial.Windspeed||'N/A'} km/h`],
                ['Rain:', `${trial.Rain||'N/A'} mm`],
            ];
            doc.autoTable({ startY: 42, head: [['Trial Information', '']], body: trialBody, theme: 'striped', headStyles: { fillColor: secondary }, columnStyles: { 0: { cellWidth: 40, fontStyle: 'bold' } }, didDrawPage: data => finalY = data.cursor.y });
            if (trial.Temperature) { doc.autoTable({ startY: finalY + 2, head: [['Weather', '']], body: weatherBody, theme: 'striped', headStyles: { fillColor: secondary }, columnStyles: { 0: { cellWidth: 40, fontStyle: 'bold' } }, didDrawPage: data => finalY = data.cursor.y }); }
            const addTextBlock = (title, content) => { finalY += 10; doc.setFontSize(14).setTextColor(...secondary).text(title, 14, finalY); finalY += 6; doc.setFontSize(10).setTextColor(80); const split = doc.splitTextToSize(String(content || 'N/A'), doc.internal.pageSize.width - 28); doc.text(split, 14, finalY); finalY += (split.length * 4) + 5; };
            addTextBlock('Conclusion', trial.Conclusion); addTextBlock('Notes', trial.Notes);
            if (withIngredients) { const f = state.formulations.find(f => f.ID === trial.FormulationID); if (f && f.IngredientsJSON) { const ings = JSON.parse(f.IngredientsJSON || '[]'); if (ings.length > 0) { doc.autoTable({ startY: finalY + 5, head: [['Ingredient', 'Quantity', 'Unit']], body: ings.map(i => [i.name, i.quantity, i.unit]), theme: 'grid', headStyles: { fillColor: primary }, didDrawPage: data => finalY = data.cursor.y }); } else { doc.text('No ingredients.', 14, finalY + 10); finalY += 15; } } else { doc.text('Ingredients not available.', 14, finalY + 10); finalY += 15; } }
            const photos = JSON.parse(trial.PhotoURLs || '[]');
            if (photos.length > 0) { finalY += 10; doc.setFontSize(14).setTextColor(...secondary).text('Photos', 14, finalY); finalY += 8; const pW = 85, pH = 65; let x = 14; for (const p of photos) { if (p.url) { const imgData = await getImageAsBase64(p.url); if (imgData) { if (finalY + pH > doc.internal.pageSize.height - 20) { doc.addPage(); finalY = 20; } doc.addImage(imgData, 'JPEG', x, finalY, pW, pH); doc.setFontSize(9).setTextColor(100).text(p.label || '', x + pW / 2, finalY + pH + 4, { align: 'center' }); x += pW + 5; if (x + pW > doc.internal.pageSize.width - 14) { x = 14; finalY += pH + 15; } } } } }
            const pageCount = doc.internal.getNumberOfPages(); for(let i = 1; i <= pageCount; i++) { doc.setPage(i); doc.setFontSize(8).setTextColor(150).text(`Page ${i}/${pageCount}`, doc.internal.pageSize.width / 2, doc.internal.pageSize.height - 10, { align: 'center' }); }
            doc.save(`Trial_${trial.FormulationName}_${trial.Date}.pdf`);
        }
        
        async function exportToPpt(trialId) {
            const trial = state.trials.find(t => t.ID === trialId); if (!trial) return; showToast('Generating PPTX...');
            let pptx = new PptxGenJS();
            let title = pptx.addSlide(); title.addText(`Herbicide Trial: ${trial.FormulationName}`, { x: 0.5, y: 1, w: '90%', fontSize: 24, bold: true, align: 'center' }); title.addText(`Date: ${new Date(trial.Date).toLocaleDateString()}`, { x: 0.5, y: 2, w: '90%', fontSize: 18, align: 'center' });
            let dataSlide = pptx.addSlide(); dataSlide.addText('Trial Details', { x: 0.5, y: 0.25, w: 5, fontSize: 18, bold: true }); dataSlide.addText([ { text: 'Investigator: ', options:{bold: true} }, { text: trial.InvestigatorName||'N/A' }, { text: 'Dosage: ', options:{bold: true, breakLine: true} }, { text: trial.Dosage||'N/A' }, { text: 'Result: ', options:{bold: true, breakLine: true} }, { text: trial.Result||'N/A' }, { text: 'Conclusion: ', options:{bold: true, breakLine: true} }, { text: trial.Conclusion||'N/A' }, ], { x: 0.5, y: 1, w: '90%', fontSize: 14 });
            const photos = JSON.parse(trial.PhotoURLs || '[]'); for (const p of photos) { if (p.url) { const imgData = await getImageAsBase64(p.url); if (imgData) { let photoSlide = pptx.addSlide(); photoSlide.addText(p.label || 'Trial Photo', { x: 0.5, y: 0.25, w: '90%', fontSize: 18, bold: true, align: 'center' }); photoSlide.addImage({ data: imgData, x: 1, y: 1, w: 8, h: 4.5 }); } } }
            pptx.writeFile({ fileName: `Trial_${trial.FormulationName}_${trial.Date}.pptx` });
        }

        async function handleAiQuery(query) {
            if (!state.geminiApiKey) { return appendMessageToChat('Please add your Gemini API Key in Settings.', 'ai'); }
            appendMessageToChat(query, 'user');
            const context = `DATA:\n${state.trials.map(t => `- Trial: ${t.FormulationName}, Result: ${t.Result}, Notes: ${t.Conclusion}`).join('\n')}`;
            const prompt = `You are a helpful AI assistant. Answer questions based on the provided data. If the question is general, use your search tool. \n\n${context}\n\nUser: "${query}"`;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${state.geminiApiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], tools: [{ "google_search": {} }] }) });
                if (!response.ok) { const err = await response.json(); throw new Error(err.error.message || 'API Error'); }
                const result = await response.json(); if(!result.candidates?.[0]?.content) throw new Error("Invalid response from AI.");
                appendMessageToChat(result.candidates[0].content.parts[0].text.replace(/\n/g, '<br>'), 'ai');
            } catch (error) { console.error("AI Error:", error); appendMessageToChat(`An error occurred: ${error.message}`, 'ai'); }
        }
        function appendMessageToChat(text, sender, save = true) {
            if (save) { state.aiChatHistory.push({ text, sender }); localStorage.setItem('aiChatHistory', JSON.stringify(state.aiChatHistory)); }
            const chatBox = document.getElementById('ai-chat-box'); if (!chatBox) return;
            const msgDiv = document.createElement('div'); msgDiv.innerHTML = text; msgDiv.className = `${sender}-message p-3 rounded-lg max-w-xl`; chatBox.appendChild(msgDiv); chatBox.scrollTop = chatBox.scrollHeight;
        }
        
        function bindEventListeners() {
            document.querySelector('nav').addEventListener('click', e => { if (e.target.matches('.nav-link')) { e.preventDefault(); switchPage(e.target.dataset.page); } });
            document.body.addEventListener('click', e => {
                const target = e.target.closest('[data-action]');
                if (!target) return;

                if (['edit', 'delete'].includes(target.dataset.action) || target.dataset.action.startsWith('export')) {
                    e.stopPropagation();
                }

                const { action, type, id, index, sort } = target.dataset;

                const actions = {
                    openModal: () => handleOpenModal(type),
                    'open-organise-modal': () => openModal('organise'),
                    'fetch-weather': fetchWeather,
                    edit: () => handleEdit(type, id),
                    delete: () => handleDelete(type, id),
                    'view-trial': () => openTrialDetail(id),
                    'sort-trials': () => applyFilters({ sortBy: sort }),
                    'export-pdf-with-ingredients': () => generateTrialPdf(id, { withIngredients: true }),
                    'export-pdf-without-ingredients': () => generateTrialPdf(id, { withIngredients: false }),
                    'export-pdf-landscape': () => generateTrialPdf(id, { orientation: 'l' }),
                    'export-ppt': () => exportToPpt(id),
                    'export-json': exportJson,
                    'export-zip': exportWithPhotos,
                    'import-json': importJson,
                    'clear-data': () => clearAllData(true),
                    'force-reload': () => { showToast('Clearing cache & reloading...', 'success'); localStorage.clear(); setTimeout(() => window.location.reload(true), 1500); },
                    'add-ingredient-row': addFormulationIngredientRow,
                    'apply-bulk-add': handleBulkIngredients,
                    'apply-bulk-add-cost': handleBulkIngredientsCost,
                    'close-modal': closeModal,
                    'cancel-crop': closeCropper,
                    'crop-image': cropAndSaveImage,
                    'open-camera': () => openCamera(),
                    'quick-open-camera': () => openCamera(id),
                    'close-camera': closeCamera,
                    'capture-photo': capturePhoto,
                    'remove-ingredient-row': () => { target.closest('.formulation-ingredient-row').remove(); updateFormulationCost(); },
                    'remove-photo': () => { state.croppedPhotosData.splice(index, 1); updatePhotoPreview(); },
                    'reset-data-sources': () => { localStorage.removeItem('appSettings'); loadSettings(); showToast('Data sources reset.', 'success'); initializeApp(); },
                    'clear-chat': () => {
                        showConfirmation('Clear Chat History?', 'This will permanently delete the conversation.', () => {
                            state.aiChatHistory = [];
                            localStorage.removeItem('aiChatHistory');
                            const chatBox = document.getElementById('ai-chat-box');
                            if (chatBox) chatBox.innerHTML = '';
                            appendMessageToChat('Hello! Ask me a question.', 'ai', false);
                            showToast('Chat history cleared.');
                        });
                    }
                };

                const handler = actions[action];
                if (handler) {
                    e.preventDefault();
                    handler();
                }
            });

            document.body.addEventListener('input', e => {
                const target = e.target;
                 if (target.id === 'import-file-input') document.querySelector('[data-action="import-json"]').disabled = !target.files.length;
                if (target.matches('[data-action="filter"]')) applyFilters();
                if (target.matches('[data-action="select-trial"]')) {
                    const { id } = target.dataset; if (target.checked) { if (!state.selectedTrials.includes(id)) state.selectedTrials.push(id); } else { state.selectedTrials = state.selectedTrials.filter(trialId => trialId !== id); }
                    updateOrganiseBar();
                }
                if (target.id === 'trial-photos') handlePhotoSelection(e);
                if (target.matches('.photo-label-input')) state.croppedPhotosData[target.dataset.index].label = target.value;
                if (target.closest('#formulation-form')) updateFormulationCost();
            });
            document.body.addEventListener('change', async e => {
                const target = e.target;
                if (target.matches('[data-action="update-result"]')) {
                    const { id } = target.dataset; const newResult = target.value; const trialIndex = state.trials.findIndex(t => t.ID === id); if (trialIndex === -1) return; const originalResult = state.trials[trialIndex].Result;
                    state.trials[trialIndex].Result = newResult;
                    const result = await apiCall('updateTrialResult', { id, Result: newResult }, false);
                    if (result) { showToast('Result updated!', 'success'); } 
                    else { showToast('Failed to update result.', 'error'); state.trials[trialIndex].Result = originalResult; target.value = originalResult; target.className = `result-select result-${(originalResult || 'none').toLowerCase()}`; }
                }
                if (target.matches('[data-action="quick-add-photo"]')) {
                    if (target.files.length > 0) { state.currentTrialIdForCamera = target.dataset.id; state.photoQueue = [...target.files]; processPhotoQueue(); }
                    target.value = '';
                }
            });
            document.body.addEventListener('submit', e => { e.preventDefault(); handleFormSubmit(e.target); });
        }
        
        function normalizeIDs(dataArray) { return Array.isArray(dataArray) ? dataArray.map(item => ({ ...item, ID: String(item.ID || ''), FormulationID: String(item.FormulationID || '') })) : []; }
        
        function loadSettings() {
            const settings = localStorage.getItem('appSettings'); state.settings = settings ? JSON.parse(settings) : { scriptUrl: DEFAULT_SCRIPT_URL, sheetId: null, folderId: null };
            state.geminiApiKey = localStorage.getItem('geminiApiKey') || '';
            const chat = localStorage.getItem('aiChatHistory'); state.aiChatHistory = chat ? JSON.parse(chat) : [];
        }
        
        function handleDataSourceSave(form) {
            const scriptUrl = form.querySelector('#script-url').value.trim();
            const sheetId = (form.querySelector('#sheet-url').value.trim().match(/spreadsheets\/d\/([a-zA-Z0-9-_]+)/) || [])[1] || null;
            const folderId = (form.querySelector('#folder-url').value.trim().match(/folders\/([a-zA-Z0-9-_]+)/) || [])[1] || null;
            if(!scriptUrl) return showToast('Apps Script URL is required.', 'error');
            state.settings = { scriptUrl, sheetId, folderId };
            localStorage.setItem('appSettings', JSON.stringify(state.settings));
            showToast('Data sources saved! Reloading app...');
            setTimeout(() => initializeApp(), 1000);
        }

        async function initializeApp(showOverlay = true) {
            if(showOverlay) loadingOverlay.classList.remove('hidden');
            try {
                loadSettings();
                const allData = await apiCall('getAllData', {}, false);
                if (allData === null) {
                    mainContent.innerHTML = `<div class="text-center p-8 bg-white rounded-lg shadow"><p class="text-red-500 font-semibold">Could not load app data.</p><p class="text-gray-600 mt-2">Check your connection and Data Source settings.</p></div>`;
                    return;
                }
                state.ingredients = normalizeIDs(allData.ingredients); state.formulations = normalizeIDs(allData.formulations);
                state.trials = normalizeIDs(allData.trials); state.organisations = normalizeIDs(allData.organisations);
                switchPage(state.currentPage || 'formulations');
            } catch (error) {
                console.error("Initialization failed:", error);
                mainContent.innerHTML = `<div class="text-center p-8 bg-white rounded-lg shadow"><p class="text-red-500 font-semibold">A critical error occurred.</p><p class="text-gray-600 mt-2">Please check the console and refresh.</p></div>`;
            } finally {
                if(showOverlay) loadingOverlay.classList.add('hidden');
            }
        }
        bindEventListeners();
        initializeApp();
    });
    </script>
</body>
</html>

